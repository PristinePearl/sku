<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Depot Stock Hub — Smart Merged Reporting</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Configure Tailwind to use Inter font and custom colors -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
          },
          colors: {
            primary: {
              50: '#f0fdfa',
              100: '#ccfbf1',
              500: '#14b8a6',
              600: '#0d9488',
              700: '#0f766e',
            },
            accent: '#0ea5a4',
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .table-wrap {
      overflow-x: auto;
      max-height: 520px;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e1 transparent;
    }
    .table-wrap::-webkit-scrollbar { width: 6px; height: 6px; }
    .table-wrap::-webkit-scrollbar-track { background: transparent; }
    .table-wrap::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    
    .glass-morphism {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .stat-card:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
    }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  
  <!-- Top Navigation/Header -->
  <nav class="sticky top-0 z-40 w-full border-b border-slate-200 bg-white/80 backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-primary-500 rounded-lg flex items-center justify-center shadow-lg shadow-primary-500/20">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        </div>
        <div>
            <h1 class="text-xl font-bold tracking-tight text-slate-800">Depot Stock<span class="text-primary-500"> Batch Wise</span></h1>
            <p class="text-[10px] uppercase tracking-widest text-slate-400 font-bold leading-none">Batch Wise Stock Upload</p>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-4 text-sm font-medium">
          <span class="text-slate-400">Report Date:</span>
          <span id="asOf" class="bg-primary-50 px-3 py-1 rounded-full text-primary-700 font-mono font-bold border border-primary-100">Pending Upload</span>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto p-4 md:p-6 lg:p-8">
    
    <!-- Hero/Upload Section -->
    <div class="mb-8 p-6 bg-white rounded-2xl border border-slate-200 shadow-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-center">
            <div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Combine & Analyze Reports</h2>
                <p class="text-slate-500 mb-6 text-sm">Upload multiple depot stock files to generate a unified batch-wise report. Date is automatically taken from Excel data.</p>
                
                <div class="flex flex-col sm:flex-row gap-3">
                    <input id="files" type="file" accept=".xlsx,.xls,.csv" multiple
                           class="block w-full text-sm text-slate-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 transition-all border border-slate-200 rounded-full p-1" />
                    
                    <button id="process" class="bg-primary-600 hover:bg-primary-700 text-white font-bold py-2.5 px-6 rounded-full shadow-lg shadow-primary-600/20 transition-all flex items-center justify-center gap-2 whitespace-nowrap">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                        Combine Files
                    </button>
                </div>
            </div>
            <div class="bg-slate-50 rounded-xl p-5 border border-dashed border-slate-300">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Quick Stats</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="stat-card bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Depots</p>
                        <p id="countDepots" class="text-xl font-black text-slate-800">0</p>
                    </div>
                    <div class="stat-card bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Products</p>
                        <p id="countProducts" class="text-xl font-black text-slate-800">0</p>
                    </div>
                    <div class="stat-card bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Merged Rows</p>
                        <p id="countRows" class="text-xl font-black text-slate-800">0</p>
                    </div>
                    <div class="stat-card bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Total Qty</p>
                        <p id="countQty" class="text-xl font-black text-slate-800">0</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex flex-col lg:flex-row gap-6">
      
      <!-- Left: Dynamic Report Table -->
      <div class="flex-grow order-2 lg:order-1">
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="p-4 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                <div class="flex items-center gap-4">
                    <h3 class="font-bold text-slate-700">Stock Inventory Matrix</h3>
                    <div class="hidden sm:flex gap-2">
                        <span class="px-2 py-0.5 rounded-md bg-red-100 text-red-700 text-[10px] font-bold border border-red-200 uppercase">Expired</span>
                        <span class="px-2 py-0.5 rounded-md bg-amber-100 text-amber-700 text-[10px] font-bold border border-amber-200 uppercase">Short (≤6m)</span>
                        <span class="px-2 py-0.5 rounded-md bg-sky-100 text-sky-700 text-[10px] font-bold border border-sky-200 uppercase">Long (>6m)</span>
                    </div>
                </div>
                <button id="exportXlsx" class="text-xs font-bold text-primary-600 hover:text-primary-700 flex items-center gap-1 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    Download .xlsx
                </button>
            </div>
            
            <div id="tableContainer" class="p-0">
                <div class="py-20 flex flex-col items-center justify-center text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 opacity-20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    <p class="text-sm font-medium">Ready to process your files.</p>
                </div>
            </div>
        </div>
      </div>

      <!-- Right: Sidebar -->
      <div class="w-full lg:w-80 space-y-6 order-1 lg:order-2">
        
        <!-- Depot List -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
            <h4 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                Depot Breakdown
            </h4>
            <div class="max-h-60 overflow-y-auto pr-2 space-y-2" id="depotsList">
                <p class="text-xs text-slate-400 italic text-center py-4">No data loaded.</p>
            </div>
        </div>

        <!-- Smart Filters -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
            <h4 class="text-sm font-bold text-slate-800 mb-4 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-primary-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
                Smart Filters
            </h4>
            <div class="grid grid-cols-1 gap-2">
                <button id="filterAll" class="w-full text-left px-4 py-2 rounded-lg bg-slate-100 text-slate-700 text-xs font-bold hover:bg-slate-200 transition-colors">Show All</button>
                <button id="filterExpired" class="w-full text-left px-4 py-2 rounded-lg bg-red-50 text-red-700 text-xs font-bold hover:bg-red-100 transition-colors">Expired Only</button>
                <button id="filterShort" class="w-full text-left px-4 py-2 rounded-lg bg-amber-50 text-amber-700 text-xs font-bold hover:bg-amber-100 transition-colors">Short Expiry (≤6m)</button>
                <button id="filterLong" class="w-full text-left px-4 py-2 rounded-lg bg-sky-50 text-sky-700 text-xs font-bold hover:bg-sky-100 transition-colors">Long Expiry (>6m)</button>
            </div>
        </div>

        <!-- Sync Action -->
        <div class="bg-primary-700 rounded-2xl shadow-lg p-6 text-white overflow-hidden relative">
            <div class="absolute -right-4 -top-4 w-24 h-24 bg-white/10 rounded-full"></div>
            <h4 class="text-sm font-bold mb-1 relative z-10">Cloud Sync</h4>
            <p class="text-[11px] text-primary-100 mb-5 relative z-10">Push the merged data to the master spreadsheet archive.</p>
            <button id="saveToSheet" class="w-full py-3 bg-white text-primary-700 font-bold rounded-xl shadow-xl hover:bg-primary-50 transition-all flex items-center justify-center gap-2 relative z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                Push to Master Sheet
            </button>
        </div>
      </div>
    </div>
  </main>

  <!-- External Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

  <script>
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwKSSo3923VjuwLllxRyzA2wkaQ4GzkLj0T4GYINOrvBv12L1KvKoBcd6W8FKJZroNS/exec";
    
    const fileInput = document.getElementById('files');
    const processBtn = document.getElementById('process');
    const exportBtn = document.getElementById('exportXlsx');
    const tableContainer = document.getElementById('tableContainer');
    const depotsList = document.getElementById('depotsList');
    const syncBtn = document.getElementById('saveToSheet');
    const asOfDisplay = document.getElementById('asOf');
    
    let MERGED = [];
    let DEPOT_ORDER = [];
    let GLOBAL_REPORT_DATE = "";

    function keyify(s){ return (s||'').toString().trim().toLowerCase().replace(/\s+/g,' '); }

    function workbookToRecords(wb) {
      const records = [];
      wb.SheetNames.forEach(sn => {
        const sheet = wb.Sheets[sn];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: true });
        if (!rows || rows.length === 0) return;

        let headerRow = -1;
        for (let i = 0; i < Math.min(rows.length, 10); i++) {
          const r = rows[i].map(c => keyify(c));
          if (r.includes('item name') && r.includes('batch no')) {
            headerRow = i;
            break;
          }
        }
        if (headerRow === -1) return;

        const hdr = rows[headerRow].map(c => keyify(c));
        const data = rows.slice(headerRow + 1).filter(r => r.some(c => c));
        const idx = {};
        hdr.forEach((h, i) => (idx[h] = i));

        data.forEach(r => {
          const rec = {};
          
          let dateVal = r[idx['date']];
          if (typeof dateVal === 'number') {
            rec.date = moment(new Date(Math.round((dateVal - 25569) * 86400 * 1000))).format('DD-MM-YYYY');
          } else if (dateVal) {
            rec.date = moment(dateVal.toString().trim(), ['DD-MM-YYYY', 'YYYY-MM-DD']).format('DD-MM-YYYY');
          } else {
            rec.date = "";
          }

          rec.div_code = (r[idx['div code']] || '').toString().trim();
          rec.div_name = (r[idx['div name']] || '').toString().trim();
          rec.depot_name = (r[idx['depot name']] || r[idx['depot code']] || '').toString().trim();
          rec.item_code = (r[idx['item code']] || '').toString().trim();
          rec.item_name = (r[idx['item name']] || '').toString().trim();
          rec.batch_no = (r[idx['batch no']] || '').toString().trim();
          rec.mrp = parseFloat(r[idx['mrp']] || 0);
          rec.total_quantity = parseFloat(r[idx['total quantity']] || 0);
          rec.total_value = parseFloat(r[idx['total value']] || 0);

          let expRaw = r[idx['expiry date']];
          let expMoment = null;
          if (typeof expRaw === 'number') expMoment = moment(new Date(Math.round((expRaw - 25569) * 86400 * 1000)));
          else expMoment = moment((expRaw || '').toString().trim(), ['MM-YYYY', 'DD-MM-YYYY', 'YYYY-MM-DD']);

          if (expMoment && expMoment.isValid()) {
            rec.expiry = expMoment.endOf('month').toDate();
            rec.expiry_mm_yyyy = expMoment.format('MM-YYYY');
          } else {
            rec.expiry = null;
            rec.expiry_mm_yyyy = '';
          }

          if (rec.item_code && rec.batch_no) records.push(rec);
        });
      });
      return records;
    }

    function mergeAll(fileRecordsArray) {
      const grouped = {};
      const datesFound = {};
      DEPOT_ORDER = [];

      fileRecordsArray.forEach(f => {
        f.records.forEach(r => {
          // Track most frequent date
          if (r.date) datesFound[r.date] = (datesFound[r.date] || 0) + 1;

          const d = r.depot_name || 'Unspecified';
          if (!DEPOT_ORDER.includes(d)) DEPOT_ORDER.push(d);

          const key = `${r.item_code}|${r.batch_no}|${r.expiry_mm_yyyy}`;
          if (!grouped[key]) {
            grouped[key] = { ...r, per_depot: {}, total_quantity: 0, total_value: 0 };
          }
          grouped[key].per_depot[d] = (grouped[key].per_depot[d] || 0) + r.total_quantity;
          grouped[key].total_quantity += r.total_quantity;
          grouped[key].total_value += r.total_value;
        });
      });

      // Determine the report date from uploaded data
      const sortedDates = Object.entries(datesFound).sort((a,b) => b[1] - a[1]);
      GLOBAL_REPORT_DATE = sortedDates.length ? sortedDates[0][0] : moment().format('DD-MM-YYYY');
      asOfDisplay.textContent = GLOBAL_REPORT_DATE;

      MERGED = Object.values(grouped);
      classify();
    }

    function classify() {
      // Logic based on global report date or current month
      const reportDate = moment(GLOBAL_REPORT_DATE, 'DD-MM-YYYY');
      
      MERGED.forEach(r => {
        if (!r.expiry) { r.expiry_type = 'Unknown'; return; }
        const exp = moment(r.expiry);
        
        if (exp.isBefore(reportDate, 'month')) {
            r.expiry_type = 'Expired';
        } else {
            const diffMonths = exp.diff(reportDate, 'months', true);
            if (diffMonths <= 6) {
                r.expiry_type = 'Short';
            } else {
                r.expiry_type = 'Long';
            }
        }
      });
    }

    function renderTable(filter = null) {
      const rows = MERGED.filter(r => !filter || r.expiry_type === filter);
      
      document.getElementById('countDepots').textContent = DEPOT_ORDER.length;
      document.getElementById('countProducts').textContent = new Set(MERGED.map(r => r.item_code)).size;
      document.getElementById('countRows').textContent = MERGED.length;
      document.getElementById('countQty').textContent = MERGED.reduce((s, r) => s + r.total_quantity, 0).toLocaleString();

      depotsList.innerHTML = DEPOT_ORDER.map(d => {
        const qty = MERGED.reduce((s, r) => s + (r.per_depot[d] || 0), 0);
        return `
            <div class="flex items-center justify-between p-2 rounded-lg border border-slate-100 bg-slate-50">
                <span class="text-[11px] font-bold text-slate-600 truncate mr-2">${d}</span>
                <span class="text-[11px] font-mono font-black text-primary-700">${qty.toLocaleString()}</span>
            </div>
        `;
      }).join('') || '<p class="text-xs text-slate-400 italic text-center py-4">No data loaded.</p>';

      if (rows.length === 0) {
          tableContainer.innerHTML = '<div class="py-20 text-center text-slate-400">No records to display.</div>';
          return;
      }

      let html = `<div class="table-wrap"><table class="w-full text-[11px] text-left border-collapse">
        <thead class="sticky top-0 bg-white shadow-sm ring-1 ring-slate-200">
          <tr>
            <th class="px-3 py-3 font-bold uppercase text-slate-400">Item Name</th>
            <th class="px-3 py-3 font-bold uppercase text-slate-400">Batch</th>
            <th class="px-3 py-3 font-bold uppercase text-slate-400">Expiry</th>
            ${DEPOT_ORDER.map(d => `<th class="px-3 py-3 font-bold uppercase text-slate-400 text-right">${d}</th>`).join('')}
            <th class="px-3 py-3 font-bold uppercase text-slate-800 text-right">Total Qty</th>
            <th class="px-3 py-3 font-bold uppercase text-slate-400">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">`;

      rows.forEach(r => {
        let badge = 'bg-slate-100 text-slate-600';
        if (r.expiry_type === 'Expired') badge = 'bg-red-100 text-red-700';
        else if (r.expiry_type === 'Short') badge = 'bg-amber-100 text-amber-700';
        else if (r.expiry_type === 'Long') badge = 'bg-sky-100 text-sky-700';

        html += `<tr class="hover:bg-slate-50">
            <td class="px-3 py-3">
                <div class="font-bold text-slate-800">${r.item_name}</div>
                <div class="text-[9px] text-slate-400">${r.item_code}</div>
            </td>
            <td class="px-3 py-3 font-mono text-slate-500">${r.batch_no}</td>
            <td class="px-3 py-3 text-slate-600">${r.expiry_mm_yyyy}</td>
            ${DEPOT_ORDER.map(d => `<td class="px-3 py-3 text-right font-mono text-slate-400">${(r.per_depot[d] || 0).toLocaleString()}</td>`).join('')}
            <td class="px-3 py-3 text-right font-black text-slate-800">${r.total_quantity.toLocaleString()}</td>
            <td class="px-3 py-3"><span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase ${badge}">${r.expiry_type}</span></td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      tableContainer.innerHTML = html;
    }

    processBtn.onclick = async () => {
      const files = Array.from(fileInput.files);
      if (files.length === 0) return showModal('Error', 'Please select files first.', 'error');
      
      processBtn.disabled = true;
      processBtn.innerHTML = `<svg class="animate-spin w-4 h-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;

      const fileData = [];
      for (const f of files) {
        try {
          const buf = await f.arrayBuffer();
          const wb = XLSX.read(buf, { type: 'array' });
          fileData.push({ records: workbookToRecords(wb) });
        } catch (e) { console.error(e); }
      }

      mergeAll(fileData);
      renderTable();
      processBtn.disabled = false;
      processBtn.textContent = 'Combine Files';
    };

    exportBtn.onclick = () => {
      if (!MERGED.length) return;
      const wb = XLSX.utils.book_new();
      const wsData = MERGED.map(r => {
        const o = { 
            'Date': GLOBAL_REPORT_DATE,
            'Item Code': r.item_code, 
            'Item Name': r.item_name, 
            'Batch': r.batch_no, 
            'Expiry': r.expiry_mm_yyyy 
        };
        DEPOT_ORDER.forEach(d => o[d] = r.per_depot[d] || 0);
        o['Total Qty'] = r.total_quantity;
        o['Status'] = r.expiry_type;
        return o;
      });
      XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(wsData), 'Merged Report');
      XLSX.writeFile(wb, `Merged_Stock_${GLOBAL_REPORT_DATE.replace(/-/g,'')}.xlsx`);
    };

    syncBtn.onclick = async () => {
        if (!MERGED.length) return showModal('Warning', 'No data to sync.', 'warning');
        
        syncBtn.disabled = true;
        syncBtn.textContent = 'Syncing...';

        const payload = MERGED.map(r => ({
            date: GLOBAL_REPORT_DATE,
            div_code: r.div_code,
            div_name: r.div_name,
            item_code: r.item_code,
            item_name: r.item_name,
            batch_no: r.batch_no,
            expiry_mm_yyyy: r.expiry_mm_yyyy,
            mrp: r.mrp,
            Kerala: r.per_depot['Kerala'] || 0,
            Palepu: r.per_depot['Palepu'] || 0,
            Coimbatore: r.per_depot['Coimbatore'] || 0,
            Bangalore: r.per_depot['Bangalore'] || 0,
            total_quantity: r.total_quantity,
            total_value: r.total_value,
            expiry_type: r.expiry_type
        }));

        try {
            // Using POST to Apps Script Web App
            await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            showModal('Success', 'Data push request sent to Google Sheets Archive.', 'success');
        } catch (err) {
            showModal('Error', 'Sync failed. Please check your connection.', 'error');
        } finally {
            syncBtn.disabled = false;
            syncBtn.textContent = 'Push to Master Sheet';
        }
    };

    document.getElementById('filterAll').onclick = () => renderTable();
    document.getElementById('filterExpired').onclick = () => renderTable('Expired');
    document.getElementById('filterShort').onclick = () => renderTable('Short');
    document.getElementById('filterLong').onclick = () => renderTable('Long');

    function showModal(title, message, type) {
        const div = document.createElement('div');
        div.className = "fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 p-4 backdrop-blur-sm";
        div.innerHTML = `<div class="bg-white p-6 rounded-2xl max-w-sm w-full shadow-2xl border border-slate-200">
            <h3 class="text-lg font-bold mb-2 ${type === 'error' ? 'text-red-600' : 'text-slate-800'}">${title}</h3>
            <p class="text-sm text-slate-500 mb-6">${message}</p>
            <button onclick="this.closest('.fixed').remove()" class="w-full py-3 bg-slate-100 hover:bg-slate-200 font-bold rounded-xl transition-colors">Close</button>
        </div>`;
        document.body.appendChild(div);
    }
  </script>
</body>
</html>
