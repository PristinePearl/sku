<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Dashboard & Planning</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="icon" type="image/png" href="https://www.pristinepearlpharma.in/images/alt-logo.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; }
    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    .nav-active { background-color: #f1f5f9; color: #4f46e5; font-weight: 600; border-right: 4px solid #4f46e5; }
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    .table-container { border-radius: 1rem; border: 1px solid #e2e8f0; overflow: hidden; background: white; }
    .critical-pulse { animation: pulse-red 2s infinite; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    .report-card { transition: all 0.2s ease; border: 1px solid #e2e8f0; cursor: pointer; position: relative; }
    .report-card:hover { transform: translateY(-4px); border-color: #4f46e5; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .preview-scroll::-webkit-scrollbar { height: 6px; width: 6px; }
    .preview-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
  </style>
</head>

<body class="bg-slate-50 h-screen overflow-hidden flex flex-col md:flex-row">

  <!-- SIDEBAR -->
  <aside class="w-full md:w-72 bg-white border-r border-slate-200 flex flex-col h-full shadow-lg z-20">
    <div class="p-6 flex items-center gap-3 border-b border-slate-100">
      <div class="bg-indigo-600 p-2 rounded-xl text-white shadow-md">
        <i data-lucide="package-search" class="w-6 h-6"></i>
      </div>
      <div>
        <h1 class="text-lg font-bold text-slate-800 tracking-tight">Planning Dashboard</h1>
        <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Stock & Planning</p>
      </div>
    </div>

    <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
      <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-2">Operations</p>
      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-600 rounded-xl hover:bg-slate-50 nav-active" onclick="show('req', this)">
        <i data-lucide="layout-grid" class="w-4 h-4"></i> Stock & Requirements
      </button>
      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-600 rounded-xl hover:bg-slate-50" onclick="show('plan', this)">
        <i data-lucide="clipboard-list" class="w-4 h-4"></i> Reorder Plan
      </button>
      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-600 rounded-xl hover:bg-slate-50" onclick="show('po-track', this)">
        <i data-lucide="truck" class="w-4 h-4"></i> PO Pipeline
      </button>

      <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-6">Health Check</p>
      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-red-600 rounded-xl hover:bg-red-50" onclick="show('alerts', this)">
        <i data-lucide="alert-triangle" class="w-4 h-4"></i> Critical Alerts <span id="alertCount" class="ml-auto bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full">0</span>
      </button>

      <p class="px-4 text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 mt-6">Insights</p>
      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-600 rounded-xl hover:bg-slate-50" onclick="show('reports', this)">
        <i data-lucide="file-text" class="w-4 h-4"></i> Export Hub
      </button>
<button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-600 rounded-xl hover:bg-slate-50"
        onclick="show('ai-pearl', this)">
  <i data-lucide="sparkles" class="w-4 h-4 text-indigo-500"></i> Pearl AI Analyst
</button>
<button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-slate-600 rounded-xl hover:bg-slate-50"
        onclick="show('knowledge', this)">
  <i data-lucide="book-open" class="w-4 h-4"></i> Knowledge Hub
</button>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 relative">
    
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 sticky top-0 bg-slate-50/90 backdrop-blur-md z-10 py-2">
      <div>
        <h2 id="pageTitle" class="text-2xl font-bold text-slate-800">Stock & Requirements</h2>
        <p class="text-slate-500 text-xs mt-1">Snapshot Date: <span id="displayDate" class="font-bold text-indigo-600">Loading...</span></p>
      </div>
      <div class="flex items-center gap-3 bg-white p-1.5 rounded-xl shadow-sm border border-slate-200">
        <label class="text-[10px] font-bold text-slate-400 uppercase px-2">Filter Date</label>
        <input type="date" id="dateFilter" class="bg-transparent text-sm font-medium text-slate-600 outline-none pr-2" onchange="handleDateChange(this.value)">
        <button onclick="fetchData()" class="p-2 hover:bg-slate-100 rounded-lg text-indigo-600 transition-colors">
            <i data-lucide="refresh-cw" class="w-4 h-4"></i>
        </button>
      </div>
    </header>

    <div id="loader" class="hidden flex items-center justify-center p-20">
        <div class="flex flex-col items-center gap-4">
            <div class="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
            <p class="text-slate-400 text-sm font-medium">Synchronizing enterprise data...</p>
        </div>
    </div>

    <div id="errorOverlay" class="hidden flex items-center justify-center p-12 bg-red-50 rounded-3xl border border-red-100">
        <div class="flex flex-col items-center gap-4 text-center max-w-md">
            <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center">
                <i data-lucide="wifi-off" class="w-6 h-6"></i>
            </div>
            <h3 class="text-lg font-bold text-red-900">Connection Interrupted</h3>
            <p id="errorMessage" class="text-red-700 text-xs leading-relaxed">Network timeout detected.</p>
            <button onclick="fetchData()" class="px-6 py-2 bg-red-600 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-red-700 transition-all">RETRY SYNCHRONIZATION</button>
        </div>
    </div>

    <section id="req" class="section active">
        <div class="table-container shadow-sm overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs whitespace-nowrap">
                    <thead>
                        <tr class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase tracking-wider">
                            <th class="px-6 py-4">Item Catalog</th>
                            <th class="px-6 py-4 text-center">Physical Stock</th>
                            <th class="px-6 py-4 text-center text-orange-600">Short Expiry</th>
                            <th class="px-6 py-4 text-center bg-indigo-50 text-indigo-700">Usable (S.ED)</th>
                            <th class="px-6 py-4 text-center">Prog Requirement</th>
                            <th class="px-6 py-4 text-center">Prog Variance</th>
                            <th class="px-6 py-4 text-center">OSH Requirement</th>
                            <th class="px-6 py-4 text-center">OSH Variance</th>
                        </tr>
                    </thead>
                    <tbody id="reqBody" class="divide-y divide-slate-100 text-slate-700"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="plan" class="section">
      <div class="table-container shadow-sm">
        <div class="overflow-x-auto">
          <table class="w-full text-left text-xs whitespace-nowrap">
            <thead>
              <tr class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase tracking-wider">
                <th class="px-6 py-4">Item Catalog</th>
                <th class="px-6 py-4 text-center text-orange-600">Short Exp</th>
                <th class="px-6 py-4 text-center">Usable Stock</th>
                <th class="px-6 py-4 text-center text-blue-700">PO Pipeline</th>
                <th class="px-6 py-4 text-center">Daily Avg Sales</th>
                <th class="px-6 py-4 text-center">Coverage (Stock holding)</th>
                <th class="px-6 py-4 text-center bg-slate-100 text-slate-700">MOQ</th>
                <th class="px-6 py-4 text-center bg-indigo-50 text-indigo-700 font-black">Suggested Order</th>
              </tr>
            </thead>
            <tbody id="planBody" class="divide-y divide-slate-100 text-slate-700"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="alerts" class="section">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-6 rounded-2xl border-l-4 border-red-500 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Immediate Stock-Out</p>
                <div class="flex items-baseline gap-2 mt-1">
                    <h3 id="severeCount" class="text-3xl font-black text-slate-800">0</h3>
                    <span class="text-red-500 text-xs font-bold font-mono">< 60 Days</span>
                </div>
            </div>
            <div class="bg-white p-6 rounded-2xl border-l-4 border-amber-500 shadow-sm">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Low Inventory Alerts</p>
                <div class="flex items-baseline gap-2 mt-1">
                    <h3 id="lowCount" class="text-3xl font-black text-slate-800">0</h3>
                    <span class="text-amber-600 text-xs font-bold font-mono">60â€“90 Days</span>
                </div>
            </div>
            <div class="bg-slate-800 p-6 rounded-2xl shadow-xl">
                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider">Total Units Gap (OSH)</p>
                <div class="flex items-baseline gap-2 mt-1">
                    <h3 id="shortfallVal" class="text-3xl font-black text-white">0</h3>
                    <span class="text-indigo-400 text-xs font-bold">Qty Needed</span>
                </div>
            </div>
        </div>
        <div class="table-container border-red-100">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs whitespace-nowrap">
                    <thead>
                        <tr class="bg-red-50 text-red-700 font-bold uppercase tracking-wider border-b border-red-100">
                            <th class="px-6 py-4">Priority SKU</th>
                            <th class="px-6 py-4 text-center">Usable Qty</th>
                            <th class="px-6 py-4 text-center">Short Expiry</th>
                            <th class="px-6 py-4 text-center">Daily Avg Sales</th>
                            <th class="px-6 py-4 text-center">Days Remaining</th>
                        </tr>
                    </thead>
                    <tbody id="alertBody" class="divide-y divide-red-50 text-slate-700"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="reports" class="section">
        <div class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h3 class="text-xl font-bold text-slate-800">Reports</h3>
                <p class="text-slate-500 text-xs">View & Export</p>
            </div>
            <button onclick="exportToExcel()" class="px-6 py-3 bg-slate-900 text-white rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-slate-800 transition-all shadow-lg active:scale-95">
                <i data-lucide="download-cloud" class="w-4 h-4"></i> MASTER CONSOLIDATED XLS
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 gap-4 mb-8">
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('gap')">
                <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="sigma" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">GAP Analysis</h4>
                <p class="text-slate-500 text-[10px] mt-1">Usable vs Requirements.</p>
            </div>
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('short_expiry')">
                <div class="w-8 h-8 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="hourglass" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">Short Expiry Aging</h4>
                <p class="text-slate-500 text-[10px] mt-1">Batch-level audit by Depot.</p>
            </div>
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('procurement')">
                <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="shopping-cart" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">Procurement Priority</h4>
                <p class="text-slate-500 text-[10px] mt-1">Suggested PO with MOQ.</p>
            </div>
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('risk_matrix')">
                <div class="w-8 h-8 bg-red-100 text-red-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="alert-octagon" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">Stock-Out Risk Matrix</h4>
                <p class="text-slate-500 text-[10px] mt-1">High-risk coverage items.</p>
            </div>
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('depot_dist')">
                <div class="w-8 h-8 bg-emerald-100 text-emerald-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="map-pin" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">Depot Distribution</h4>
                <p class="text-slate-500 text-[10px] mt-1">Regional health comparison.</p>
            </div>
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('mfr_details')">
                <div class="w-8 h-8 bg-slate-100 text-slate-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="factory" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">Manufacturer Details</h4>
                <p class="text-slate-500 text-[10px] mt-1">Item-wise MFR & MOQ mapping.</p>
            </div>
        </div>
        
        <div id="reportPreviewArea" class="hidden">
            <div class="bg-white rounded-3xl border border-slate-200 shadow-2xl overflow-hidden mb-12">
                <div class="px-8 py-5 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                    <div>
                        <h3 id="previewTitle" class="font-black text-slate-800 tracking-tight uppercase text-sm">Report Preview</h3>
                    </div>
                    <div class="flex gap-2">
                        <button id="downloadSpecificBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-[10px] font-black hover:bg-indigo-700 transition-all flex items-center gap-2">
                            <i data-lucide="download" class="w-3 h-3"></i> DOWNLOAD XLS (Summary + Detail)
                        </button>
                        <button onclick="closePreview()" class="text-slate-400 hover:text-slate-600 p-2"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div id="previewContent" class="overflow-auto max-h-[600px] preview-scroll p-0"></div>
            </div>
        </div>
    </section>

    <section id="po-track" class="section">
        <div class="table-container" id="poTrackContent"></div>
    </section>

    <!-- PEARL AI SECTION -->
    <section id="ai-pearl" class="section">
        <div class="pearl-gradient p-10 rounded-3xl shadow-sm mb-8 relative overflow-hidden">
            <div class="relative z-10 flex flex-col md:flex-row items-center gap-8">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
                    <img src="https://www.pristinepearlpharma.in/images/alt-logo.png" alt="Pearl AI" class="h-16 w-auto object-contain">
                </div>
                <div>
                    <h2 class="text-3xl font-black text-slate-800 tracking-tight">Pearl AI</h2>
                    <p class="text-slate-500 text-sm max-w-md mt-1 italic">AI designed to study & analyse the data & provide analytical reports </p>
                    <div class="mt-6 flex flex-wrap gap-3">
                        <button onclick="runPearlAnalysis()" id="pearlBtn" class="px-6 py-3 bg-slate-900 text-white rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-black transition-all">
                            <i data-lucide="play" class="w-4 h-4"></i> EXECUTE DEEP ANALYSIS
                        </button>
                        <button onclick="exportPearlReport()" id="pearlExportBtn" class="hidden px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-indigo-700 transition-all shadow-md">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> EXPORT DETAILED PEARL AI REPORT (XLS)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="pearlResults" class="hidden space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Metrics -->
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Vital Health Indicators</h3>
                    <div class="space-y-4" id="pearlMetrics"></div>
                </div>
                <!-- Suggestions -->
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Executive AI Suggestions</h3>
                    <div class="space-y-3" id="pearlSuggestions"></div>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                    <h3 class="text-xs font-black text-slate-800 uppercase">Analysis Output & Logistics Comments</h3>
                    <span class="text-[10px] text-slate-400">Deep-dive assessment per SKU</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-[11px]">
                        <thead>
                            <tr class="bg-slate-50/50 text-slate-400 font-bold border-b border-slate-100">
                                <th class="px-6 py-3">SKU Catalog</th>
                                <th class="px-6 py-3">Health Status</th>
                                <th class="px-6 py-3">Risk Assessment</th>
                                <th class="px-6 py-3">Detailed Logistics Comment</th>
                            </tr>
                        </thead>
                        <tbody id="pearlTable" class="divide-y divide-slate-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <section id="reports" class="section">
        <div class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h3 class="text-xl font-bold text-slate-800">Export Hub</h3>
                <p class="text-slate-500 text-xs">Internal Logistics Reporting Center.</p>
            </div>
            <button onclick="exportToExcel()" class="px-6 py-3 bg-slate-900 text-white rounded-xl font-bold text-xs flex items-center gap-2 hover:bg-slate-800 transition-all shadow-lg active:scale-95">
                <i data-lucide="download-cloud" class="w-4 h-4"></i> EXPORT MASTER LOGISTICS FILE
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('gap')">
                <div class="w-8 h-8 bg-slate-100 text-slate-800 rounded-lg flex items-center justify-center mb-3"><i data-lucide="sigma" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">GAP Analysis Report</h4>
                <p class="text-[10px] text-slate-400 mt-1">Variance against OSH targets.</p>
            </div>
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('short_expiry')">
                <div class="w-8 h-8 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="hourglass" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">Short Expiry Aging</h4>
                <p class="text-[10px] text-slate-400 mt-1">Items requiring immediate liquidation.</p>
            </div>
            <div class="report-card bg-white p-5 rounded-2xl" onclick="previewReport('procurement')">
                <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mb-3"><i data-lucide="shopping-cart" class="w-4 h-4"></i></div>
                <h4 class="font-bold text-slate-800 text-sm">Procurement Priorities</h4>
                <p class="text-[10px] text-slate-400 mt-1">Suggested PO quantities based on burn.</p>
            </div>
        </div>
        <div id="reportPreviewArea" class="hidden">
            <div class="bg-white rounded-3xl border border-slate-200 shadow-2xl overflow-hidden mb-12">
                <div id="previewContent" class="overflow-auto max-h-[600px] p-0"></div>
            </div>
        </div>
    </section>
    <!-- NEW KNOWLEDGE HUB SECTION -->
    <section id="knowledge" class="section">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Terminology Definitions -->
            <div class="space-y-6">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="book" class="w-5 h-5 text-indigo-600"></i> Dictionary of Terms
                </h3>
                <div class="bg-white rounded-2xl border border-slate-200 divide-y divide-slate-100 shadow-sm overflow-hidden">
                    <div class="p-5">
                        <h4 class="text-sm font-bold text-indigo-700">Physical Stock</h4>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">The total quantity currently stored across all depots (Kerala, Palepu, Coimbatore, Bangalore) as reported in the latest snapshot.</p>
                    </div>
                    <div class="p-5">
                        <h4 class="text-sm font-bold text-indigo-700">Usable Stock</h4>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">The total quantity of current stock across all depots (Kerala, Palepu, Coimbatore, Bangalore) - Short Expiry stock .</p>
                    </div>
                    <div class="p-5">
                        <h4 class="text-sm font-bold text-indigo-700">Short Expiry</h4>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">Stock quantity labeled as 'Short' in the batch master. These items are excluded from 'Usable Stock' to prevent distribution of aging inventory.</p>
                    </div>
                    <div class="p-5">
                        <h4 class="text-sm font-bold text-indigo-700">Prog Requirement</h4>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">Program Requirement: Stock Requirement plan automated by this program.</p>
                    </div>
                    <div class="p-5">
                        <h4 class="text-sm font-bold text-indigo-700">OSH Requirement</h4>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">Operational Sales Head Requirement: The Stock requirement plan by OSH.</p>
                    </div>
                    <div class="p-5">
                        <h4 class="text-sm font-bold text-indigo-700">MOQ</h4>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">Minimum Order Quantity: The smallest unit of stock a supplier will accept for a single purchase order.</p>
                    </div>
                    <div class="p-5">
                        <h4 class="text-sm font-bold text-indigo-700">Daily Avg Sales / Daily Burn</h4>
                        <p class="text-xs text-slate-500 mt-1 leading-relaxed">The average number of units consumed per day, calculated from the previous year sales data.</p>
                    </div>
                </div>
            </div>

            <!-- Formulas & Calculations -->
            <div class="space-y-6">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="variable" class="w-5 h-5 text-indigo-600"></i> Formulas & Calculations
                </h3>
                
                <div class="space-y-4">
                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Usable Stock Logic</span>
                        <div class="math-block mt-2">Usable Stock = Physical Stock - Short Expiry Qty</div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Daily Avg Sales (Consumption Rate)</span>
                        <div class="math-block mt-2">Daily Avg Sales = Prev.Yr Sales / 180 Days (6months)</div>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Stock Coverage (Days)</span>
                        <div class="math-block mt-2">Coverage = Usable Stock / Daily Avg Sales</div>
                        <p class="text-[10px] text-slate-400 mt-2 italic">*If Daily Avg Sales is 0, Coverage is reported as 0.</p>
                    </div>

                    <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm">
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Suggested Order Calculation</span>
                        <div class="math-block mt-2">
                            Base = ((Lead Time + Safety Stock) Ã— Dail Avg Sales) - Usable Stock - PO Pipeline<br><br>
                            If MOQ > 0:<br>
                            Order = CEIL(Base / MOQ) Ã— MOQ<br>
                            Else:<br>
                            Order = ROUND(Base)
                        </div>
                    </div>
                    
                    <div class="bg-indigo-900 p-5 rounded-2xl shadow-lg">
                        <h4 class="text-white font-bold text-sm mb-2 flex items-center gap-2">
                            <i data-lucide="info" class="w-4 h-4"></i> Data Hygiene Note
                        </h4>
                        <p class="text-indigo-200 text-[10px] leading-relaxed">
                            System ignores negative stock values in calculations. Variance analysis compares current Usable Stock against fixed Program and OSH Requirement. All PO Pipeline data is filtered to show 'Pending Qty' only.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </section>
  </main>

  <script>
    const apiKey = ""; 
    let STOCK = [], REQ_MAP = {}, PO_MAP = {}, FINAL = [], RAW_PO_DATA = [], BATCH_STOCK = [], MOQ_MAP = {}, RAW_STOCK_DATE_FILTERED = [];
const MIN_COVERAGE_DAYS = 90; // ðŸ”’ Global minimum stock holding (3 months)

    const STOCK_URL = "https://script.google.com/macros/s/AKfycby0zKw1g1s_yB3J2p8QC_h31DBBCaswlK8xwt07bip98txOSMvOWgGPJwUWltDdg9uo9w/exec";
    const REQ_URL = "https://script.google.com/macros/s/AKfycbzkiKxXCQAFTTaA5P5t7kpgoXARPOMv9V2u4hnDW4CdM65C_tAkc1YxfIjvN4Njix8EIA/exec";
    const PO_URL = "https://script.google.com/macros/s/AKfycbzFZOc1qQw5kn7M88w251WOnZGzBwBznytNpx-QqxMRE89kHUkN8feVxH_qG38H3KXd/exec";
    const BATCH_URL = "https://script.google.com/macros/s/AKfycbx4hqFN0DhMDm22q0_EkS_E4EAApVavgZz8FEZEdUV0Jg0uMVaUUg3S8FyL9vy3H5KM/exec";
    const MOQ_URL = "https://script.google.com/macros/s/AKfycbwfWL5Iu25uPYWxsRA0pLNtjSzDo86K3jXhSAw_P-RrPTlK5rLPpbLnv00X7972skCj/exec";

    window.onload = fetchData;

    function getValueByKeys(obj, keys) {
      if (!obj) return null;
      const entryKeys = Object.keys(obj);
      for (const target of keys) {
        const found = entryKeys.find(k => k.trim().toLowerCase() === target.toLowerCase());
        if (found !== undefined) return obj[found];
      }
      return null;
    }

    function getISOStringFromMixed(raw) {
      if (!raw) return null;
      let d;
      if (!isNaN(raw) && typeof raw !== 'boolean' && raw > 40000) {
        d = new Date((parseFloat(raw) - 25569) * 86400 * 1000);
      } else {
        d = new Date(raw);
        if (isNaN(d.getTime())) {
            const parts = String(raw).split('/');
            if (parts.length === 3) d = new Date(parts[2], parts[1] - 1, parts[0]);
        }
      }
      return isNaN(d.getTime()) ? null : d.toISOString().split('T')[0];
    }

    function getLocalDateString(dateInput) {
      const iso = getISOStringFromMixed(dateInput);
      if (!iso) return "N/A";
      const [y, m, d] = iso.split('-');
      return `${d}/${m}/${y}`;
    }
function formatDaysToYMD(totalDays) {
    totalDays = Math.max(0, Math.floor(totalDays));

    const years = Math.floor(totalDays / 365);
    const months = Math.floor((totalDays % 365) / 30);
    const days = totalDays % 30;

    let parts = [];
    if (years > 0) parts.push(`${years}Y`);
    if (months > 0) parts.push(`${months}M`);
    if (days > 0 || parts.length === 0) parts.push(`${days}D`);

    return parts.join(" ");
}

    async function fetchWithRetry(url, retries = 5, backoff = 1000) {
        for (let i = 0; i < retries; i++) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); 
            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                clearTimeout(timeoutId);
                const delay = (backoff * Math.pow(2, i)) + (Math.random() * 500);
                if (i === retries - 1) throw err;
                await new Promise(r => setTimeout(r, delay));
            }
        }
    }

    async function fetchData() {
        document.getElementById('loader').classList.remove('hidden');
        document.getElementById('errorOverlay').classList.add('hidden');
        try {
          const results = await Promise.allSettled([
            fetchWithRetry(STOCK_URL),
            fetchWithRetry(REQ_URL),
            fetchWithRetry(PO_URL),
            fetchWithRetry(BATCH_URL),
            fetchWithRetry(MOQ_URL)
          ]);
          const [sRes, rRes, pRes, bRes, mRes] = results;
          if (sRes.status === 'fulfilled') STOCK = sRes.value; 
          else throw new Error("Stock data unreachable.");
          if (rRes.status === 'fulfilled') {
            REQ_MAP = {};
            rRes.value.forEach(x => {
                const code = String(getValueByKeys(x, ["Item Code", "itemCode"]) || "").trim().toLowerCase();
                if (code) REQ_MAP[code] = x;
            });
          }
          if (pRes.status === 'fulfilled') RAW_PO_DATA = pRes.value;
          if (bRes.status === 'fulfilled') BATCH_STOCK = bRes.value;
          if (mRes.status === 'fulfilled' && Array.isArray(mRes.value)) {
              MOQ_MAP = {};
              mRes.value.forEach(row => {
                  const code = String(getValueByKeys(row, ["Item Code", "itemCode"]) || "").trim().toLowerCase();
                  const val = parseFloat(getValueByKeys(row, ["MOQ", "moq"]) || 0);
                  if (code) MOQ_MAP[code] = val;
              });
          }
          if(STOCK && STOCK.length > 0) {
              const dateMap = STOCK.map(i => getISOStringFromMixed(getValueByKeys(i, ["Date", "date"]))).filter(d => d);
              if (dateMap.length > 0) {
                const latestStr = [...new Set(dateMap)].sort().pop();
                document.getElementById('dateFilter').value = latestStr;
                document.getElementById('displayDate').innerText = getLocalDateString(latestStr);
              }
          }
          build();
        } catch (e) { 
            document.getElementById('errorOverlay').classList.remove('hidden');
            document.getElementById('errorMessage').innerText = `Sync Error: ${e.message}`;
        } finally {
            document.getElementById('loader').classList.add('hidden');
            lucide.createIcons();
        }
    }

    function build() {
      const selectedDate = document.getElementById('dateFilter').value;
      const dataMap = {};
      RAW_STOCK_DATE_FILTERED = [];

      Object.values(REQ_MAP).forEach(item => {
          const code = String(getValueByKeys(item, ["Item Code", "itemCode"]) || "").trim().toLowerCase();
          if(!code) return;
          dataMap[code] = { 
            name: getValueByKeys(item, ["Item Name", "itemName"]) || "Unknown SKU", 
            code: code.toUpperCase(),
            stock: 0, shortQty: 0, usableStock: 0, openPo: 0,
            moq: MOQ_MAP[code] || 0,
            mfg: getValueByKeys(item, ["Manufacturer", "MFR"]) || "General", 
            prog: +(getValueByKeys(item, ["Program Req"]) || 0),
            osh: +(getValueByKeys(item, ["OSH Req"]) || 0),
            lt: +(getValueByKeys(item, ["Lead Time"]) || 0),
            ss: +(getValueByKeys(item, ["Safety Stock"]) || 0),
            prevH2: +(getValueByKeys(item, ["Prev H2 Sales"]) || 0),
            kerala: 0, palepu: 0, coimbatore: 0, bangalore: 0
          };
      });

      if (Array.isArray(STOCK)) {
          STOCK.forEach(r => {
            if (getISOStringFromMixed(getValueByKeys(r, ["Date", "date"])) === selectedDate) {
                RAW_STOCK_DATE_FILTERED.push(r);
                const code = String(getValueByKeys(r, ["Item Code", "itemCode"]) || "").trim().toLowerCase();
                if (dataMap[code]) {
                    dataMap[code].kerala += +(r.Kerala||0);
                    dataMap[code].palepu += +(r.Palepu||0);
                    dataMap[code].coimbatore += +(r.Coimbatore||0);
                    dataMap[code].bangalore += +(r.Bangalore||0);
                    dataMap[code].stock += (+(r.Kerala||0) + +(r.Palepu||0) + +(r.Coimbatore||0) + +(r.Bangalore||0));
                }
            }
          });
      }

      if (Array.isArray(BATCH_STOCK)) {
          const batchDates = BATCH_STOCK.map(b => getISOStringFromMixed(getValueByKeys(b, ["Date", "date"]))).filter(d => d);
          const targetBatchDate = [...new Set(batchDates)].sort().pop();
          BATCH_STOCK.forEach(b => {
              if (getISOStringFromMixed(getValueByKeys(b, ["Date", "date"])) === targetBatchDate) {
                  const code = String(getValueByKeys(b, ["Item Code", "itemCode"]) || "").trim().toLowerCase();
                  const expType = String(getValueByKeys(b, ["Expiry Type"]) || "").trim();
                  if (dataMap[code] && expType.toLowerCase() === "short") {
                      dataMap[code].shortQty += parseFloat(getValueByKeys(b, ["Total Quantity"]) || 0);
                  }
              }
          });
      }

      if (Array.isArray(RAW_PO_DATA)) {
          RAW_PO_DATA.forEach(x => {
            const code = String(getValueByKeys(x, ["Item Code", "itemCode"]) || "").trim().toLowerCase();
            const pendingQty = parseFloat(getValueByKeys(x, ["Pending Qty"]) || 0);
            if (dataMap[code] && pendingQty > 0) dataMap[code].openPo += pendingQty;
          });
      }

      FINAL = Object.values(dataMap);
FINAL.forEach(r => {
    r.usableStock = Math.max(0, r.stock - r.shortQty); 

    // âœ… FORCE INTEGER DAILY BURN
    r.dailySales = Math.round((r.prevH2 || 0) / 180);

    // âœ… FORCE INTEGER COVERAGE DAYS
    r.holdDays = r.dailySales > 0
        ? Math.round(r.usableStock / r.dailySales)
        : 0;

    r.reqDays = r.lt + r.ss;
});
      renderAll();
    }

    function renderAll() { renderReq(); renderPlan(); renderPOTrack(); renderAlerts(); lucide.createIcons(); }

    function renderReq() {
      document.getElementById('reqBody').innerHTML = FINAL.map(r => `
          <tr class="hover:bg-slate-50">
            <td class="px-6 py-4"><div class="font-semibold text-slate-800">${r.name}</div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${r.code}</div></td>
            <td class="px-6 py-4 text-center">${Math.round(r.stock)}</td>
            <td class="px-6 py-4 text-center font-bold text-orange-600">${Math.round(r.shortQty) || '-'}</td>
            <td class="px-6 py-4 text-center font-black bg-indigo-50 text-indigo-800">${Math.round(r.usableStock)}</td>
            <td class="px-6 py-4 text-center text-slate-500">${Math.round(r.prog)}</td>
            <td class="px-6 py-4 text-center font-bold ${r.usableStock < r.prog ? 'text-red-500' : 'text-emerald-600'}">${Math.round(r.usableStock - r.prog)}</td>
            <td class="px-6 py-4 text-center text-slate-500">${Math.round(r.osh)}</td>
            <td class="px-6 py-4 text-center font-bold ${r.usableStock < r.osh ? 'text-red-500' : 'text-emerald-600'}">${Math.round(r.usableStock - r.osh)}</td>
          </tr>`).join('');
    }

    function renderPlan() {
        document.getElementById('planBody').innerHTML = FINAL.map(r => {
            let base = Math.max(0, (r.reqDays * r.dailySales) - r.usableStock - r.openPo);
            let finalSuggest = r.moq > 0 ? Math.ceil(base / r.moq) * r.moq : Math.round(base);
            return `<tr class="hover:bg-slate-50">
                <td class="px-6 py-4"><div class="font-semibold text-slate-800">${r.name}</div><div class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">${r.code}</div></td>
                <td class="px-6 py-4 text-center font-bold text-orange-600">${Math.round(r.shortQty) || '-'}</td>
                <td class="px-6 py-4 text-center font-bold">${Math.round(r.usableStock)}</td>
                <td class="px-6 py-4 text-center font-bold text-blue-700">${Math.round(r.openPo)}</td>
                <td class="px-6 py-4 text-center text-slate-500 font-mono">${r.dailySales}</td>
                <td class="px-6 py-4 text-center font-bold ${r.holdDays < MIN_COVERAGE_DAYS ? 'text-red-500' : 'text-emerald-600'}">
  ${formatDaysToYMD(r.holdDays)}
</td>
                <td class="px-6 py-4 text-center font-bold text-slate-500 bg-slate-100/50">${r.moq > 0 ? r.moq : '-'}</td>
                <td class="px-6 py-4 text-center font-black text-indigo-600 bg-indigo-50">${finalSuggest > 0 ? finalSuggest : '-'}</td>
            </tr>`;
        }).join('');
    }

    function renderAlerts() {
        const alerts = FINAL.filter(r => r.holdDays < MIN_COVERAGE_DAYS && r.dailySales > 0).sort((a,b) => a.holdDays - b.holdDays);
        document.getElementById('alertCount').innerText = alerts.length;
document.getElementById('severeCount').innerText =
    alerts.filter(a => a.holdDays < 60).length;
document.getElementById('lowCount').innerText =
    alerts.filter(a => a.holdDays >= 60 && a.holdDays < MIN_COVERAGE_DAYS).length;
        document.getElementById('shortfallVal').innerText = Math.round(FINAL.reduce((a,b) => a + Math.max(0, b.osh - b.usableStock), 0)).toLocaleString();

        document.getElementById('alertBody').innerHTML = alerts.map(r => `
            <tr>
                <td class="px-6 py-4 flex items-center gap-3">
                    ${r.holdDays < 60 ? '<span class="w-2 h-2 rounded-full bg-red-500 critical-pulse"></span>' : '<span class="w-2 h-2 rounded-full bg-amber-400"></span>'}
                    <div><div class="font-bold text-slate-800">${r.name}</div><div class="text-[10px] text-slate-400 font-bold tracking-tighter">${r.code}</div></div>
                </td>	
                <td class="px-6 py-4 text-center font-bold">${Math.round(r.usableStock)}</td>
                <td class="px-6 py-4 text-center font-bold text-orange-600">${Math.round(r.shortQty) || '-'}</td>
                <td class="px-6 py-4 text-center text-slate-500 font-mono">${r.dailySales}</td>
                <td class="px-6 py-4 text-center"><span class="px-3 py-1 rounded-full text-[10px] font-black tracking-tighter ${r.holdDays < 60 ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'}">
  ${formatDaysToYMD(r.holdDays)}
</td>
            </tr>`).join('');
    }

    function renderPOTrack() {
        if (!RAW_PO_DATA.length) { document.getElementById('poTrackContent').innerHTML = `<div class="p-20 text-center text-slate-400">No PO data found.</div>`; return; }
        const rows = RAW_PO_DATA.map(i => `<tr class="hover:bg-slate-50">
                <td class="px-6 py-4 font-bold text-indigo-600 uppercase tracking-tighter">${getValueByKeys(i, ["PO Number", "poNumber"]) || "N/A"}</td>
                <td class="px-6 py-4 text-slate-500 text-[10px]">${getLocalDateString(getValueByKeys(i, ["PO Date", "poDate"]))}</td>
                <td class="px-6 py-4 font-medium text-slate-800">${getValueByKeys(i, ["Item Name", "itemName"]) || "Unknown"}</td>
                <td class="px-6 py-4 text-center text-slate-500 font-bold">${Math.round(getValueByKeys(i, ["Order Qty", "orderQty"]) || 0)}</td>
                <td class="px-6 py-4 text-center font-bold text-blue-600">${getLocalDateString(getValueByKeys(i, ["expectedDelivery", "ETA"]))}</td>
                <td class="px-6 py-4 text-center font-black text-indigo-600 bg-indigo-50">${Math.round(getValueByKeys(i, ["Pending Qty", "pendingQty"]) || 0)}</td>
            </tr>`).join('');
        document.getElementById('poTrackContent').innerHTML = `<div class="overflow-x-auto"><table class="w-full text-left text-xs whitespace-nowrap">
            <thead><tr class="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase tracking-wider">
                <th class="px-6 py-4">PO Ref</th><th class="px-6 py-4">Date</th><th class="px-6 py-4">SKU</th>
                <th class="px-6 py-4 text-center">Order Qty</th><th class="px-6 py-4 text-center">ETA</th><th class="px-6 py-4 text-center">Balance</th>
            </tr></thead><tbody class="divide-y divide-slate-100">${rows}</tbody></table></div>`;
    }
    // UPDATED REPORT LOGIC FOR SUMMARY & DETAILED VIEWS
    function getReportContents(type) {
        let summary = [], detailed = [];
        switch(type) {
            case 'gap':
                summary = FINAL.map(r => ({ "Item Name": r.name, "Code": r.code, "Usable Stock": Math.round(r.usableStock), "Prog Variance": Math.round(r.usableStock - r.prog), "OSH Variance": Math.round(r.usableStock - r.osh), "Status": (r.usableStock < r.prog) ? "GAP DETECTED" : "HEALTHY" }));
                detailed = FINAL.map(r => ({ ...r }));
                break;
            case 'short_expiry':
                summary = BATCH_STOCK.filter(b => getValueByKeys(b, ["Expiry Type"])?.toLowerCase() === "short").map(r => ({ "Depot": getValueByKeys(r, ["Depot"]) || "Main", "SKU": getValueByKeys(r, ["Item Name"]), "Quantity": getValueByKeys(r, ["Total Quantity"]) }));
                detailed = BATCH_STOCK.filter(b => getValueByKeys(b, ["Expiry Type"])?.toLowerCase() === "short");
                break;
            case 'procurement':
                summary = FINAL.filter(r => r.holdDays < MIN_COVERAGE_DAYS).map(r => {
                    let base = Math.max(0, (r.reqDays * r.dailySales) - r.usableStock - r.openPo);
                    return { "Item Name": r.name, "Code": r.code, "Daily Avg Sales": r.dailySales, "Suggested Order": r.moq > 0 ? Math.ceil(base / r.moq) * r.moq : Math.round(base) };
                });
                detailed = FINAL.filter(r => r.holdDays < MIN_COVERAGE_DAYS);
                break;
            case 'risk_matrix':
              summary = FINAL.filter(r => r.holdDays < MIN_COVERAGE_DAYS).map(r => ({
  "Item": r.name,
  "Coverage": formatDaysToYMD(r.holdDays),
  "Risk": r.holdDays < 30 ? "CRITICAL" : "BELOW MINIMUM"
}));

detailed = FINAL.filter(r => r.holdDays < MIN_COVERAGE_DAYS);
                break;
            case 'depot_dist':
                summary = FINAL.map(r => ({ 
                    "Item Name": r.name, "Code": r.code,
                    "Kerala": Math.round(r.kerala), "Palepu": Math.round(r.palepu), 
                    "Coimbatore": Math.round(r.coimbatore), "Bangalore": Math.round(r.bangalore),
                    "Total Physical": Math.round(r.stock),
                    "Short Expiry": Math.round(r.shortQty),
                    "Usable Stock": Math.round(r.usableStock)
                }));
                detailed = RAW_STOCK_DATE_FILTERED;
                break;
            case 'mfr_details':
                summary = FINAL.map(r => ({ "Manufacturer": r.mfg, "Item Name": r.name, "MOQ": r.moq }));
                detailed = FINAL.map(r => ({ "MFR": r.mfg, "SKU": r.name, "Code": r.code, "MOQ": r.moq, "LeadTime": r.lt, "SafetyStock": r.ss }));
                break;
        }
        return { summary, detailed };
    }

    function previewReport(type) {
        const area = document.getElementById('reportPreviewArea');
        const content = document.getElementById('previewContent');
        const title = document.getElementById('previewTitle');
        area.classList.remove('hidden');
        const { summary, detailed } = getReportContents(type);
        title.innerText = type.replace(/_/g, ' ') + " - SUMMARY PREVIEW";

        if (!summary.length) { content.innerHTML = `<div class="p-20 text-center text-slate-400">No records found.</div>`; return; }

        let html = '<table class="w-full text-left text-[11px] whitespace-nowrap"><thead><tr class="bg-slate-100 border-b border-slate-200 text-slate-600 font-black uppercase">';
        Object.keys(summary[0]).forEach(k => html += `<th class="px-6 py-4">${k}</th>`);
        html += '</tr></thead><tbody class="divide-y divide-slate-100 text-slate-700 font-medium">';
        summary.forEach(row => {
            html += `<tr>`;
            Object.values(row).forEach(v => {
                let cls = "px-6 py-4";
                if (v === "CRITICAL" || v === "GAP DETECTED") cls += " text-red-600 font-black";
                html += `<td class="${cls}">${v}</td>`;
            });
            html += `</tr>`;
        });
        html += '</tbody></table>';
        content.innerHTML = html;
        
        document.getElementById('downloadSpecificBtn').onclick = () => {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(summary), "Summary");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(detailed), "Detailed Data");
            XLSX.writeFile(wb, `Pearl_${type}_Report.xlsx`);
        };
        area.scrollIntoView({ behavior: 'smooth' });
        lucide.createIcons();
    }

    function closePreview() { document.getElementById('reportPreviewArea').classList.add('hidden'); }

    function exportToExcel() {
        const wb = XLSX.utils.book_new();
        const exportData = FINAL.map(r => ({ "Item Name": r.name, "Code": r.code, "MFR": r.mfg, "Physical": Math.round(r.stock), "ShortExp": Math.round(r.shortQty), "Usable": Math.round(r.usableStock), "MOQ": r.moq, "Coverage": formatDaysToYMD(r.holdDays) }));
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(exportData), "Consolidated_Master");
        XLSX.writeFile(wb, `Pearl_Full_Export.xlsx`);
    }

   /* PEARL AI ENGINE - UPDATED WITH DETAILED COMMENTS */
    let pearlReportData = [];
    function runPearlAnalysis() {
        const btn = document.getElementById('pearlBtn');
        btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> GENERATING DEEP ANALYSIS...`;
        
        setTimeout(() => {
            document.getElementById('pearlResults').classList.remove('hidden');
            document.getElementById('pearlExportBtn').classList.remove('hidden');
            
            const totalItems = FINAL.length;
            const criticalItems = FINAL.filter(f => f.holdDays < 30 && f.dailySales > 0).length;
            const overstockItems = FINAL.filter(f => f.holdDays > 180).length;

            document.getElementById('pearlMetrics').innerHTML = `
                <div class="flex justify-between items-center"><span class="text-xs text-slate-500">Portfolio Scale</span><span class="font-bold text-slate-800">${totalItems} Unique SKUs</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-slate-500">Critical Stock-Out Risk</span><span class="font-bold text-red-600">${criticalItems} Critical SKUs</span></div>
                <div class="flex justify-between items-center"><span class="text-xs text-slate-500">Capital Lock-In (Overstock)</span><span class="font-bold text-amber-600">${overstockItems} Inactive SKUs</span></div>
                <div class="flex justify-between items-center border-t border-slate-100 pt-3 mt-2"><span class="text-xs font-bold text-slate-800">Overall Availability Health</span><span class="font-black text-indigo-600">${(((totalItems - criticalItems)/totalItems)*100).toFixed(1)}%</span></div>
            `;

            const topAction = FINAL.filter(f => f.holdDays < 30 && f.dailySales > 0).slice(0, 3);
            document.getElementById('pearlSuggestions').innerHTML = topAction.length 
                ? topAction.map(a => `<div class="p-3 bg-red-50 border border-red-100 rounded-xl text-[10px] font-bold text-red-800 flex gap-2 items-start"><i data-lucide="zap" class="w-4 h-4 mt-0.5"></i> <div>PRIORITY 1: ${a.name} is dangerously low (${a.holdDays.toFixed(1)} days left). Immediate PO placement of ${Math.round(a.osh)} units suggested.</div></div>`).join('')
                : `<div class="p-3 bg-emerald-50 text-emerald-800 rounded-xl text-[10px] font-bold">LOGISTICS STABLE: No immediate stock-outs detected in the next 72-hour window.</div>`;

            // GENERATE DETAILED EXPORT DATA WITH COMMENTS
            pearlReportData = FINAL.map(f => {
                let status = "NORMAL";
                let risk = "LOW";
                let action = "MAINTAIN";
                let comment = "";
               // -----------------------------------------------------
// HEALTH LOGIC â€“ 90 DAY MINIMUM COVERAGE RULE
// -----------------------------------------------------
// Policy:
// < 30 days      â†’ CRITICAL
// 30â€“89 days     â†’ BELOW MINIMUM (Needs planning)
// 90â€“180 days    â†’ HEALTHY
// > 180 days     â†’ OVERSTOCK
// -----------------------------------------------------

if (f.holdDays <= 0 && f.dailySales > 0) {
    status = "STOCK-OUT";
    risk = "CRITICAL";
    action = "SOS REORDER";

    comment = `Current usable stock is ZERO while daily burn is ${f.dailySales}. 
Immediate replenishment required to meet minimum 90-day coverage.`;
}
else if (f.holdDays < 30) {
    status = "CRITICAL LOW";
    risk = "HIGH";
    action = "URGENT PO";

    comment = `Coverage is only ${f.holdDays} days, which is critically below the minimum 
required coverage of 90 days. Immediate PO action is mandatory.`;
}
else if (f.holdDays < MIN_COVERAGE_DAYS) {
    status = "BELOW MINIMUM";
    risk = "HIGH";
    action = "PLAN PO";

    comment = `Stock coverage (${f.holdDays} days) is below the defined minimum of 
90 days. Procurement planning should be initiated to avoid future stock-out.`;
}
else if (f.holdDays > 180) {
    status = "OVERSTOCK";
    risk = "LIQUIDATION";
    action = "PAUSE PO";

    comment = `Inventory holding is ${f.holdDays} days, significantly above operational 
requirement. Capital lock-in risk identified; recommend pausing new POs and 
evaluating liquidation or redistribution.`;
}
else {
    status = "HEALTHY";
    risk = "LOW";
    action = "MONITOR";

    comment = `Stock coverage is ${f.holdDays} days, which satisfies the minimum 
90-day coverage policy. Inventory levels are stable and aligned with planning norms.`;
}

// Append warnings if applicable
if (f.shortQty > 0) {
    comment += ` WARNING: ${Math.round(f.shortQty)} units are marked as Short Expiry 
and excluded from usable stock calculations.`;
}

if (f.openPo > 0) {
    comment += ` Active PO pipeline detected with ${Math.round(f.openPo)} units pending receipt.`;
}

                if (f.shortQty > 0) {
                    comment += ` WARNING: ${Math.round(f.shortQty)} units flagged as Short Expiry. High risk of dump loss if not liquidated.`;
                }

                if (f.openPo > 0) {
                    comment += ` Pipeline active with ${Math.round(f.openPo)} units in transit.`;
                }

                return { 
                    "Item Code": f.code,
                    "SKU Name": f.name, 
                    "Usable Stock": Math.round(f.usableStock),
                    "Daily Sales Burn": f.dailySales,                 // Rounded daily average sales
"Coverage (Days)": formatDaysToYMD(f.holdDays),   // Converted to Y M D format
                    "Health Status": status, 
                    "Risk Level": risk, 
                    "Suggested Action": action,
                    "Logistics Analysis Comment": comment
                };
            }).sort((a,b) => a["Coverage (Days)"] - b["Coverage (Days)"]);

            document.getElementById('pearlTable').innerHTML = pearlReportData.slice(0, 15).map(r => `
                <tr class="hover:bg-slate-50">
                    <td class="px-6 py-4">
                        <div class="font-bold text-slate-800">${r["SKU Name"]}</div>
                        <div class="text-[9px] text-slate-400 font-mono">${r["Item Code"]}</div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-0.5 rounded text-[9px] font-black
${r["Health Status"] === 'STOCK-OUT' || r["Health Status"] === 'CRITICAL LOW'
  ? 'bg-red-100 text-red-700'
  : r["Health Status"] === 'BELOW MINIMUM'
  ? 'bg-orange-100 text-orange-700'
  : r["Health Status"] === 'OVERSTOCK'
  ? 'bg-blue-100 text-blue-800'
  : 'bg-emerald-100 text-emerald-700'}">
  ${r["Health Status"]}
</span>
                    </td>
                    <td class="px-6 py-4 text-[10px] font-bold uppercase ${r["Risk Level"] === 'CRITICAL' || r["Risk Level"] === 'HIGH' ? 'text-red-600' : 'text-slate-500'}">${r["Risk Level"]}</td>
                    <td class="px-6 py-4 text-slate-500 italic max-w-xs truncate" title="${r["Logistics Analysis Comment"]}">${r["Logistics Analysis Comment"]}</td>
                </tr>
            `).join('');

            btn.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4"></i> ANALYSIS REFRESHED`;
            lucide.createIcons();
        }, 1200);
    }

    function exportPearlReport() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(pearlReportData);
        
        // Style adjustments (optional: setting column widths for the export)
        ws['!cols'] = [
            {wch: 15}, {wch: 35}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 60}
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, "Pearl Detailed Analysis");
        XLSX.writeFile(wb, `Pearl_Strategic_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`);
    }
    function show(id, btn) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
      if(btn) btn.classList.add('nav-active');
      document.getElementById('pageTitle').innerText = btn.innerText.replace(/[0-9]/g, '').trim();
      closePreview();
    }
    
    function handleDateChange(v) { document.getElementById('displayDate').innerText = getLocalDateString(v); build(); }
  </script>
</body>
</html>

