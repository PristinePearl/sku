<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Stock Planning Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for XLSX Export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- MathJax for Formulas -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    body { font-family: 'Inter', sans-serif; }
    .section { display: none; }
    .section.active { display: block; animation: fadeIn 0.3s ease-out; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .nav-active {
      background-color: #f3f4f6;
      color: #4f46e5;
      font-weight: 600;
      border-right: 4px solid #4f46e5;
    }

    .ai-gradient {
      background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
    }

    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }

    .class-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }
    .class-card:hover {
        transform: translateY(-4px);
    }
    .class-card.selected-class {
        border-color: #6366f1;
        background-color: #f5f3ff;
        box-shadow: 0 0 0 2px #6366f1;
    }
    
    .mfg-item {
        transition: all 0.2s ease;
    }
    .mfg-item.active-mfg {
        background-color: #eef2ff;
        border-color: #6366f1;
    }

    #reportModal {
      backdrop-filter: blur(8px);
      background-color: rgba(0,0,0,0.4);
    }
    
    .kb-card {
      background: white;
      border: 1px solid #f1f5f9;
      border-radius: 1.25rem;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .formula-pill {
        background: #f1f5f9;
        padding: 2px 8px;
        border-radius: 6px;
        font-family: monospace;
        color: #475569;
    }
  </style>
</head>

<body class="bg-gray-50 h-screen overflow-hidden flex flex-col md:flex-row">

  <!-- SIDEBAR -->
  <aside class="w-full md:w-72 bg-white border-r border-gray-200 flex flex-col h-full shadow-sm z-10">
    <div class="p-6 flex items-center gap-3 border-b border-gray-100">
      <div class="bg-indigo-600 p-2 rounded-lg text-white">
        <i data-lucide="package" class="w-6 h-6"></i>
      </div>
      <h1 class="text-xl font-bold text-gray-800 tracking-tight">StockSystem</h1>
    </div>

    <nav class="flex-1 p-4 space-y-1 overflow-y-auto">
      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-4 mb-2">Operations</p>
      
      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all nav-active" onclick="show('req', this)">
        <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Stock vs Requirement
      </button>
      
      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all" onclick="show('plan', this)">
        <i data-lucide="clipboard-list" class="w-4 h-4"></i> Planning
      </button>

      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all" onclick="show('mfg', this)">
        <i data-lucide="factory" class="w-4 h-4"></i> Manufacturers
      </button>

      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all" onclick="show('reports', this)">
        <i data-lucide="file-text" class="w-4 h-4"></i> Reports & Export
      </button>

      <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-4 mb-2 mt-4">Intelligence</p>

      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all" onclick="show('ai', this)">
        <i data-lucide="sparkles" class="w-4 h-4 text-indigo-500"></i> Pearl AI
      </button>

      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all" onclick="show('insights', this)">
        <i data-lucide="zap" class="w-4 h-4"></i> Inventory Insights
      </button>

      <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all" onclick="show('alerts', this)">
        <i data-lucide="bell" class="w-4 h-4 text-red-500"></i> Critical Alerts
      </button>

      <div class="pt-4 mt-4 border-t border-gray-100">
        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-4 mb-2">Help</p>
        <button class="nav-btn w-full flex items-center gap-3 px-4 py-3 text-sm text-gray-600 rounded-xl hover:bg-gray-50 transition-all" onclick="show('guide', this)">
          <i data-lucide="book-open" class="w-4 h-4"></i> Knowledge Base
        </button>
      </div>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
    
    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div>
        <h2 id="pageTitle" class="text-2xl font-bold text-gray-800">Stock vs Requirement</h2>
        <p class="text-gray-500 text-sm">Targeting <span id="displayDate" class="font-medium text-indigo-600">...</span></p>
      </div>
      <div class="flex items-center gap-3">
        <div class="relative">
          <i data-lucide="search" class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="searchInput" placeholder="Search items..." oninput="build()" 
                 class="pl-9 pr-4 py-2 bg-white border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none w-48 shadow-sm">
        </div>
        <input type="date" id="dateFilter" class="bg-white border border-gray-200 rounded-xl text-sm px-4 py-2 outline-none cursor-pointer shadow-sm" onchange="handleDateChange(this.value)">
      </div>
    </header>

    <!-- SECTION: STOCK VS REQUIREMENT -->
    <section id="req" class="section active space-y-6">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs whitespace-nowrap">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-100 text-gray-400 uppercase text-[10px] font-bold tracking-widest">
                            <th class="px-6 py-4">Item Name</th>
                            <th class="px-6 py-4">Total Stock</th>
                            <th class="px-6 py-4">Prog. Req</th>
                            <th class="px-6 py-4">OSH Req</th>
                            <th class="px-6 py-4">Prog %</th>
                            <th class="px-6 py-4">OSH %</th>
                            <th class="px-6 py-4">Bal Prog</th>
                            <th class="px-6 py-4">Bal OSH</th>
                        </tr>
                    </thead>
                    <tbody id="reqBody" class="divide-y divide-gray-50 text-gray-600"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- SECTION: PLANNING -->
    <section id="plan" class="section">
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full text-left text-xs whitespace-nowrap">
            <thead>
              <tr class="bg-gray-50 border-b border-gray-100 font-bold text-gray-500 uppercase text-[10px] tracking-widest">
                <th class="px-6 py-4">Item Name</th>
                <th class="px-6 py-4">Stock</th>
                <th class="px-6 py-4">Req. Days</th>
                <th class="px-6 py-4">Holding Days</th>
                <th class="px-6 py-4">Status</th>
                <th class="px-6 py-4">Suggested PO</th>
              </tr>
            </thead>
            <tbody id="planBody" class="divide-y divide-gray-50 text-gray-600"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SECTION: MANUFACTURERS -->
    <section id="mfg" class="section">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-280px)]">
            <div class="lg:col-span-4 bg-white rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden">
                <div class="p-4 border-b border-gray-100 bg-gray-50/50">
                    <h3 class="font-bold text-gray-800 text-[10px] uppercase tracking-widest">Manufacturer List</h3>
                </div>
                <div id="mfgList" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
            </div>
            <div class="lg:col-span-8 bg-white rounded-2xl border border-gray-100 shadow-sm flex flex-col overflow-hidden">
                <div id="mfgDetailHeader" class="p-6 border-b border-gray-100 flex items-center justify-between">
                    <h3 id="selectedMfgName" class="text-xl font-bold text-gray-800">Select Manufacturer</h3>
                </div>
                <div class="flex-1 overflow-y-auto">
                    <table class="w-full text-left text-sm whitespace-nowrap">
                        <thead>
                            <tr class="bg-gray-50 text-[10px] font-bold text-gray-400 uppercase tracking-widest">
                                <th class="px-6 py-4">Product Name</th>
                                <th class="px-6 py-4">Stock</th>
                                <th class="px-6 py-4">Coverage</th>
                            </tr>
                        </thead>
                        <tbody id="mfgProductList" class="divide-y divide-gray-50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION: REPORTS -->
    <section id="reports" class="section space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Existing Report: Inventory Status -->
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col">
                <div class="flex items-center gap-3 mb-4">
                  <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><i data-lucide="package" class="w-5 h-5"></i></div>
                  <h4 class="font-bold text-gray-800">Inventory Status</h4>
                </div>
                <p class="text-xs text-gray-500 mb-6 flex-1">Breakdown of total current stock and ABC classification.</p>
                <div class="flex gap-2">
                  <button onclick="previewReport('status')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-colors">PREVIEW</button>
                  <button onclick="downloadReportXlsx('status')" class="flex-1 py-2 bg-indigo-600 text-white rounded-xl text-[10px] font-bold hover:bg-indigo-700 transition-colors">EXPORT</button>
                </div>
            </div>

            <!-- Existing Report: Depot Wise -->
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col">
                <div class="flex items-center gap-3 mb-4">
                  <div class="p-2 bg-cyan-50 text-cyan-600 rounded-lg"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                  <h4 class="font-bold text-gray-800">Depot Wise Report</h4>
                </div>
                <p class="text-xs text-gray-500 mb-6 flex-1">Distribution for Coimbatore, Palepu, Kerala & Bangalore.</p>
                <div class="flex gap-2">
                  <button onclick="previewReport('depot')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-colors">PREVIEW</button>
                  <button onclick="downloadReportXlsx('depot')" class="flex-1 py-2 bg-cyan-600 text-white rounded-xl text-[10px] font-bold hover:bg-cyan-700 transition-colors">EXPORT</button>
                </div>
            </div>

            <!-- Existing Report: Critical Shortages -->
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col">
              <div class="flex items-center gap-3 mb-4">
                <div class="p-2 bg-red-50 text-red-600 rounded-lg"><i data-lucide="alert-circle" class="w-5 h-5"></i></div>
                <h4 class="font-bold text-gray-800">Critical Shortages</h4>
              </div>
              <p class="text-xs text-gray-500 mb-6 flex-1">Items at risk of stock-out based on lead times.</p>
              <div class="flex gap-2">
                <button onclick="previewReport('shortage')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-colors">PREVIEW</button>
                <button onclick="downloadReportXlsx('shortage')" class="flex-1 py-2 bg-red-600 text-white rounded-xl text-[10px] font-bold hover:bg-red-700 transition-colors">EXPORT</button>
              </div>
            </div>

            <!-- NEW: Stock Out Trend -->
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col">
                <div class="flex items-center gap-3 mb-4">
                  <div class="p-2 bg-amber-50 text-amber-600 rounded-lg"><i data-lucide="trending-down" class="w-5 h-5"></i></div>
                  <h4 class="font-bold text-gray-800">Stock Out Trend</h4>
                </div>
                <p class="text-xs text-gray-500 mb-6 flex-1">Items running out within 7, 15, and 30 days.</p>
                <div class="flex gap-2">
                  <button onclick="previewReport('trend')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-colors">PREVIEW</button>
                  <button onclick="downloadReportXlsx('trend')" class="flex-1 py-2 bg-amber-600 text-white rounded-xl text-[10px] font-bold hover:bg-amber-700 transition-colors">EXPORT</button>
                </div>
            </div>

            <!-- NEW: Manufacturer Summary -->
            <div class="bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col">
                <div class="flex items-center gap-3 mb-4">
                  <div class="p-2 bg-emerald-50 text-emerald-600 rounded-lg"><i data-lucide="factory" class="w-5 h-5"></i></div>
                  <h4 class="font-bold text-gray-800">Mfg Summary</h4>
                </div>
                <p class="text-xs text-gray-500 mb-6 flex-1">Manufacturer level stock value and item count distribution.</p>
                <div class="flex gap-2">
                  <button onclick="previewReport('mfg_summary')" class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-xl text-[10px] font-bold hover:bg-gray-200 transition-colors">PREVIEW</button>
                  <button onclick="downloadReportXlsx('mfg_summary')" class="flex-1 py-2 bg-emerald-600 text-white rounded-xl text-[10px] font-bold hover:bg-emerald-700 transition-colors">EXPORT</button>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION: INVENTORY INSIGHTS -->
    <section id="insights" class="section space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div id="card-abc-a" class="class-card group bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center text-center hover:bg-indigo-50/20" onclick="selectAbcClass('A')">
                <div class="w-14 h-14 bg-indigo-100 text-indigo-600 rounded-2xl flex items-center justify-center mb-4 text-xl font-black group-hover:scale-110 transition-transform">A</div>
                <h4 class="font-bold text-gray-800">High Velocity Items</h4>
                <p class="text-[10px] text-gray-400 uppercase tracking-tighter mb-4">Top 20% of Daily Sales</p>
                <p id="insight-a-count" class="text-4xl font-black text-indigo-600">0</p>
                <div class="mt-4 text-[9px] font-bold text-indigo-400 group-hover:underline">CLICK TO VIEW PRODUCTS</div>
            </div>
            <div id="card-abc-b" class="class-card group bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center text-center hover:bg-amber-50/20" onclick="selectAbcClass('B')">
                <div class="w-14 h-14 bg-amber-100 text-amber-600 rounded-2xl flex items-center justify-center mb-4 text-xl font-black group-hover:scale-110 transition-transform">B</div>
                <h4 class="font-bold text-gray-800">Moderate Items</h4>
                <p class="text-[10px] text-gray-400 uppercase tracking-tighter mb-4">Middle 30% of Daily Sales</p>
                <p id="insight-b-count" class="text-4xl font-black text-amber-600">0</p>
                <div class="mt-4 text-[9px] font-bold text-amber-400 group-hover:underline">CLICK TO VIEW PRODUCTS</div>
            </div>
            <div id="card-abc-c" class="class-card group bg-white p-6 rounded-2xl border border-gray-100 shadow-sm flex flex-col items-center text-center hover:bg-gray-100/50" onclick="selectAbcClass('C')">
                <div class="w-14 h-14 bg-gray-100 text-gray-600 rounded-2xl flex items-center justify-center mb-4 text-xl font-black group-hover:scale-110 transition-transform">C</div>
                <h4 class="font-bold text-gray-800">Low Velocity Items</h4>
                <p class="text-[10px] text-gray-400 uppercase tracking-tighter mb-4">Bottom 50% of Daily Sales</p>
                <p id="insight-c-count" class="text-4xl font-black text-gray-600">0</p>
                <div class="mt-4 text-[9px] font-bold text-gray-400 group-hover:underline">CLICK TO VIEW PRODUCTS</div>
            </div>
        </div>

        <div id="abcItemsContainer" class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hidden">
            <div class="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                <h3 id="abcSelectedTitle" class="text-sm font-bold text-gray-700">Products in Class A</h3>
                <span class="text-[10px] font-bold text-gray-400">DAILY SALES VS CURRENT STOCK</span>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs whitespace-nowrap">
                  <thead>
                      <tr class="bg-white text-[10px] font-bold text-gray-400 uppercase tracking-widest border-b">
                          <th class="px-6 py-3">Item</th>
                          <th class="px-6 py-3">Daily Avg</th>
                          <th class="px-6 py-3">Stock</th>
                          <th class="px-6 py-3">Days Remaining</th>
                      </tr>
                  </thead>
                  <tbody id="abcProductList" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- SECTION: AI LAB -->
    <section id="ai" class="section space-y-6">
        <div class="ai-gradient p-8 rounded-3xl text-white relative overflow-hidden shadow-xl">
            <div class="relative z-10 max-w-lg">
                <h3 class="text-2xl font-bold mb-2">Pearl AI</h3>
                <p class="text-indigo-100 text-sm mb-6">Pearl AI analyzes current stock levels, historical sales velocity, and lead times to generate a high-priority procurement strategy.</p>
                <button onclick="runIntegratedAnalysis()" id="aiBtn"
  class="px-8 py-3 bg-white text-indigo-600 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl hover:bg-indigo-50 transition-all flex items-center gap-2">
  <i data-lucide="zap" class="w-4 h-4"></i> RUN ANALYSIS
</button>
<button onclick="exportAiAnalysis()" id="aiExportBtn"
  class="mt-3 px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2 hidden">
  <i data-lucide="download" class="w-4 h-4"></i> EXPORT AI REPORT
</button>
            </div>
            <div class="absolute right-0 top-0 bottom-0 w-1/3 flex items-center justify-center opacity-20 pointer-events-none">
                <i data-lucide="brain-circuit" class="w-48 h-48 text-white"></i>
            </div>
        </div>
        <div id="aiResponse" class="grid grid-cols-1 lg:grid-cols-2 gap-6 hidden">
            <div id="aiSummary" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 text-sm leading-relaxed text-gray-600"></div>
            <div id="aiActions" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 space-y-3"></div>
        </div>
    </section>

    <!-- SECTION: ALERTS -->
    <section id="alerts" class="section">
        <div id="alertGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
    </section>

    <!-- SECTION: KNOWLEDGE BASE -->
    <section id="guide" class="section space-y-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <!-- GLOSSARY CARD -->
        <div class="kb-card">
          <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-indigo-50 text-indigo-600 rounded-lg"><i data-lucide="book" class="w-5 h-5"></i></div>
            <h3 class="text-lg font-bold text-gray-800">Operational Glossary</h3>
          </div>
          <div class="space-y-6 text-sm text-gray-600">
            <div>
              <p class="font-bold text-indigo-600 text-[10px] uppercase tracking-wider mb-1">Item Code / Item Name</p>
              <p>The unique identifier and descriptive title of the pharmaceutical or stock item as mapped in the master requirement sheet.</p>
            </div>
            <div>
              <p class="font-bold text-indigo-600 text-[10px] uppercase tracking-wider mb-1">Total Stock</p>
              <p>The aggregate sum of inventory available across all tracked locations (Kerala, Palepu, Coimbatore, and Bangalore).</p>
            </div>
            <div>
              <p class="font-bold text-indigo-600 text-[10px] uppercase tracking-wider mb-1">Program Req (Prog. Req)</p>
              <p>Automated Stock Holding requirement analysed by item wise sales.</p>
            </div>
            <div>
              <p class="font-bold text-indigo-600 text-[10px] uppercase tracking-wider mb-1">OSH Requirement (OSH Req)</p>
              <p>Operational Sales Head requirement. This is the stock requirement which is planned by OSH to ensure continuous supply without interruption.</p>
            </div>
            <div>
              <p class="font-bold text-indigo-600 text-[10px] uppercase tracking-wider mb-1">Lead Time (LT)</p>
              <p>The number of days it takes from placing an order with the manufacturer until the goods are received at the depot.</p>
            </div>
            <div>
              <p class="font-bold text-indigo-600 text-[10px] uppercase tracking-wider mb-1">Safety Stock (SS)</p>
              <p>Buffer inventory maintained to mitigate the risk of stock-outs caused by fluctuations in supply or demand.</p>
            </div>
          </div>
        </div>

<!-- PEARL AI KNOWLEDGE BASE -->
<div class="kb-card lg:col-span-2">
  <div class="flex items-center gap-3 mb-6">
    <div class="p-2 bg-purple-50 text-purple-600 rounded-lg">
      <i data-lucide="brain-circuit" class="w-5 h-5"></i>
    </div>
    <h3 class="text-lg font-bold text-gray-800">Pearl AI ‚Äì How It Works</h3>
  </div>

  <!-- FLOW DIAGRAM -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

    <div class="bg-gray-50 rounded-xl p-4 border">
      <p class="font-bold text-xs text-indigo-600 mb-2">‚ë† Data Intake</p>
      <p class="text-[11px] text-gray-600">
        Pearl AI reads stock, sales velocity, lead time, safety stock, and
        requirements for every SKU.
      </p>
    </div>

    <div class="bg-gray-50 rounded-xl p-4 border">
      <p class="font-bold text-xs text-indigo-600 mb-2">‚ë° Coverage Calculation</p>
      <p class="text-[11px] text-gray-600">
        Calculates how many days current stock can sustain sales.
      </p>
    </div>

    <div class="bg-gray-50 rounded-xl p-4 border">
      <p class="font-bold text-xs text-indigo-600 mb-2">‚ë¢ Risk Classification</p>
      <p class="text-[11px] text-gray-600">
        Items are classified as üö® Immediate, ‚ö†Ô∏è This Week, or üëÄ Monitor.
      </p>
    </div>

    <div class="bg-gray-50 rounded-xl p-4 border">
      <p class="font-bold text-xs text-indigo-600 mb-2">‚ë£ Confidence Scoring</p>
      <p class="text-[11px] text-gray-600">
        A 0‚Äì100 score represents inventory health and urgency.
      </p>
    </div>

    <div class="bg-gray-50 rounded-xl p-4 border">
      <p class="font-bold text-xs text-indigo-600 mb-2">‚ë§ Explainable AI</p>
      <p class="text-[11px] text-gray-600">
        Pearl AI explains <b>why</b> an item is flagged using real data.
      </p>
    </div>

    <div class="bg-gray-50 rounded-xl p-4 border">
      <p class="font-bold text-xs text-indigo-600 mb-2">‚ë• Decision Output</p>
      <p class="text-[11px] text-gray-600">
        Displays PO quantity, priority tags, and executive summary.
      </p>
    </div>

  </div>

  <!-- WORKED EXAMPLE -->
  <div>
    <p class="font-bold text-purple-600 text-[10px] uppercase tracking-wider mb-3">
      Worked Example ‚Äì Real SKU
    </p>

    <div class="bg-gray-50 p-4 rounded-xl border text-[11px] space-y-2">
      <div><b>SKU:</b> ENOXSET 60 PFS</div>

      <ul class="ml-4 list-disc text-gray-600">
        <li>Stock: 790 units</li>
        <li>Daily Sales: 18.2 units</li>
        <li>Required Coverage: 30 days</li>
        <li>Reorder Threshold: 15 days</li>
      </ul>

      <div class="bg-white p-2 rounded border text-center italic">
        Holding Days = 790 √∑ 18.2 ‚âà 43.4 days
      </div>

      <div class="text-gray-600">
        Result: <b>Healthy</b>, Score <b>100 / 100</b>, No PO required.
      </div>
    </div>
  </div>
</div>



        <!-- FORMULA CARD -->
        <div class="kb-card">
          <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-emerald-50 text-emerald-600 rounded-lg"><i data-lucide="function-square" class="w-5 h-5"></i></div>
            <h3 class="text-lg font-bold text-gray-800">Calculations & Logic</h3>
          </div>
          <div class="space-y-6 text-sm text-gray-600">
            <div>
                <p class="font-bold text-emerald-600 text-[10px] uppercase tracking-wider mb-2">1. Sales Velocity (Daily Sales)</p>
                <p class="mb-2">Calculated based on the last 6 months (H2) of sales data to normalize seasonal spikes.</p>
                <div class="bg-gray-50 p-4 rounded-xl border italic text-center">
                    $$V_{daily} = \frac{\text{Previous H2 Sales}}{180 \text{ days}}$$
                </div>
            </div>
            <div>
                <p class="font-bold text-emerald-600 text-[10px] uppercase tracking-wider mb-2">2. Inventory Coverage (Holding Days)</p>
                <p class="mb-2">Estimates how long current stock will last at present consumption rates.</p>
                <div class="bg-gray-50 p-4 rounded-xl border italic text-center">
                    $$D_{hold} = \frac{\text{Current Total Stock}}{V_{daily}}$$
                </div>
            </div>
            <div>
                <p class="font-bold text-emerald-600 text-[10px] uppercase tracking-wider mb-2">3. Requirement Horizon</p>
                <p class="mb-2">The total coverage required to stay safe, accounting for ordering delays.</p>
                <div class="bg-gray-50 p-4 rounded-xl border italic text-center">
                    $$D_{req} = \text{Lead Time} + \text{Safety Stock}$$
                </div>
            </div>
            <div>
                <p class="font-bold text-emerald-600 text-[10px] uppercase tracking-wider mb-2">4. Balance Program / OSH</p>
                <p class="mb-2">Net surplus or deficit against specific targets.</p>
                <div class="bg-gray-50 p-4 rounded-xl border italic text-center">
                    $$\text{Balance} = \text{Current Stock} - \text{Target Quantity}$$
                </div>
            </div>

<div>
  <p class="font-bold text-emerald-600 text-[10px] uppercase tracking-wider mb-2">
   5. Pearl AI Confidence Score
  </p>
  <p class="mb-2">
    A normalized risk score (0‚Äì100) indicating inventory health and urgency.
    Higher scores represent safer stock positions.
  </p>
  <div class="bg-gray-50 p-4 rounded-xl border italic text-center">
    $$Score = 100 - (D_{threshold} - D_{hold}) \times W$$
  </div>
  <p class="mt-2 text-[11px] text-gray-500">
    Where:
    <br>‚Ä¢ \(D_{hold}\) = Holding Days
    <br>‚Ä¢ \(D_{threshold}\) = 15 days (Reorder benchmark)
    <br>‚Ä¢ \(W\) = Risk weight (default = 6)
  </p>
</div>
      </div>
<div>
  <p class="font-bold text-emerald-600 text-[10px] uppercase tracking-wider mb-3">
    6. How Pearl AI Thinks (Decision Flow)
  </p>

  <div class="bg-gray-50 p-4 rounded-xl border text-[11px] leading-relaxed space-y-2">
    <div>‚ë† <b>Data Ingestion</b></div>
    <div class="ml-4 text-gray-600">
      Reads stock, sales velocity, lead time, safety stock, and requirements.
    </div>

    <div>‚ë° <b>Holding Days Calculation</b></div>
    <div class="ml-4 text-gray-600">
      Calculates how long current stock will last.
    </div>

    <div>‚ë¢ <b>Risk Classification</b></div>
    <div class="ml-4 text-gray-600">
      Classifies items as üö® Immediate, ‚ö†Ô∏è This Week, or üëÄ Monitor.
    </div>

    <div>‚ë£ <b>Confidence Score</b></div>
    <div class="ml-4 text-gray-600">
      Generates a 0‚Äì100 score representing inventory health.
    </div>

    <div>‚ë§ <b>Explainable Reason</b></div>
    <div class="ml-4 text-gray-600">
      Explains why the item is flagged using sales & coverage.
    </div>

    <div>‚ë• <b>PO Recommendation</b></div>
    <div class="ml-4 text-gray-600">
      Suggests PO quantity only when a gap exists.
    </div>

    <div>‚ë¶ <b>Change Tracking</b></div>
    <div class="ml-4 text-gray-600">
      Compares with previous run to show risk increase or reduction.
    </div>
  </div>
</div>

<div>
  <p class="font-bold text-emerald-600 text-[10px] uppercase tracking-wider mb-3">
    7. Worked Example ‚Äì SKU Evaluation
  </p>

  <div class="bg-gray-50 p-4 rounded-xl border text-[11px] leading-relaxed space-y-2">
    <div><b>Example SKU:</b> ENOXSET 60 PFS</div>

    <div>
      <b>Input Data</b>
      <ul class="ml-4 list-disc text-gray-600">
        <li>Stock: 790 units</li>
        <li>Daily Sales: 18.2 units</li>
        <li>Required Coverage: 30 days</li>
        <li>Reorder Threshold: 15 days</li>
      </ul>
    </div>

    <div>
      <b>Holding Days</b>
      <div class="bg-white p-2 rounded border text-center italic">
        790 √∑ 18.2 ‚âà 43.4 days
      </div>
    </div>

    <div>
      <b>Risk Status</b>
      <div class="ml-4 text-gray-600">
        Healthy (above threshold)
      </div>
    </div>

    <div>
      <b>Confidence Score</b>
      <div class="bg-white p-2 rounded border text-center italic">
        100 / 100
      </div>
    </div>

    <div>
      <b>PO Decision</b>
      <div class="ml-4 text-gray-600">
        No PO required in current cycle.
      </div>
    </div>
  </div>
</div>

    </section>

  </main>

  <!-- MODAL -->
  <div id="reportModal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-5xl max-h-[85vh] rounded-3xl shadow-2xl flex flex-col overflow-hidden">
        <div class="p-6 border-b border-gray-100 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i data-lucide="file-spreadsheet" class="w-5 h-5 text-indigo-600"></i>
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Preview</h3>
            </div>
            <button onclick="closeModal()" class="p-2 hover:bg-gray-100 rounded-full transition-colors"><i data-lucide="x" class="w-6 h-6 text-gray-400"></i></button>
        </div>
        <div class="flex-1 overflow-auto p-4 bg-gray-50/50">
            <table class="w-full text-left text-[11px] bg-white rounded-xl shadow-sm border-separate border-spacing-0 overflow-hidden">
                <thead id="modalHead" class="sticky top-0 bg-gray-100 border-b z-10 text-gray-600 uppercase font-bold tracking-widest"></thead>
                <tbody id="modalBody" class="divide-y divide-gray-100 text-gray-700"></tbody>
            </table>
        </div>
        <div class="p-6 border-t flex flex-col md:flex-row md:items-center justify-between gap-4">
            <p class="text-[10px] text-gray-400 font-medium">NOTE: Export includes "Summary" and "Full Dataset" worksheets.</p>
            <div class="flex gap-3">
                <button onclick="closeModal()" class="px-6 py-2 text-xs font-bold text-gray-500 hover:bg-gray-100 rounded-xl">CANCEL</button>
                <button id="modalDownloadBtn" class="px-6 py-2 text-xs font-bold bg-indigo-600 text-white rounded-xl shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2">
                    <i data-lucide="download" class="w-4 h-4"></i> EXPORT TO EXCEL
                </button>
            </div>
        </div>
    </div>
  </div>

  <script>

     let LAST_AI_STATE = null;
    let STOCK = [], REQ = {}, FINAL = [];

    const STOCK_URL = "https://script.google.com/macros/s/AKfycby0zKw1g1s_yB3J2p8QC_h31DBBCaswlK8xwt07bip98txOSMvOWgGPJwUWltDdg9uo9w/exec";
    const REQ_URL = "https://script.google.com/macros/s/AKfycbzkiKxXCQAFTTaA5P5t7kpgoXARPOMv9V2u4hnDW4CdM65C_tAkc1YxfIjvN4Njix8EIA/exec";

    window.onload = fetchData;

    async function fetchData() {
        try {
          const [s, r] = await Promise.all([
            fetch(STOCK_URL).then(res => res.json()),
            fetch(REQ_URL).then(res => res.json())
          ]);
          STOCK = s;
          r.forEach(x => REQ[x["Item Code"]] = x);
          if(STOCK.length > 0) {
              const latest = new Date(Math.max(...STOCK.map(i => new Date(i.Date || i.date).getTime()))).toISOString().split('T')[0];
              document.getElementById('dateFilter').value = latest;
              document.getElementById('displayDate').innerText = latest;
          }
          build();
        } catch (e) { console.error(e); }
    }

    function show(id, btn) {
      const section = document.getElementById(id);
      if(!section) return;

      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      section.classList.add('active');
      
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
      if(btn) btn.classList.add('nav-active');
      
      document.getElementById('pageTitle').innerText = btn ? btn.innerText.trim() : "Dashboard";
      
      if(window.MathJax) MathJax.typesetPromise();
      lucide.createIcons();
    }

function runIntegratedAnalysis() {

  const btn = document.getElementById('aiBtn');
  btn.disabled = true;
  btn.innerHTML = `<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> AI THINKING...`;
  lucide.createIcons();

  setTimeout(() => {

    const analysed = FINAL.map(r => {
      const hold = r.dailySales > 0 ? r.stock / r.dailySales : 0;

      // Confidence Score (0‚Äì100)
      const score = Math.round(
  Math.max(0, Math.min(100,
    100 - Math.max(0, (15 - hold)) * 6
  ))
);
const scoreColor =
  score >= 80 ? "text-green-600" :
  score >= 50 ? "text-yellow-600" :
  "text-red-600";

      // Priority Tag
      let priority = "üëÄ MONITOR";
      if (hold <= 5) priority = "üö® IMMEDIATE";
      else if (hold <= 10) priority = "‚ö†Ô∏è THIS WEEK";

      // Why explanation
      const why = `Daily sales ${r.dailySales.toFixed(2)}, stock covers ${hold.toFixed(1)} days`;

      // Suggested PO
      const poQty = Math.round(Math.max(0, (r.reqDays - hold) * r.dailySales));

     return { ...r, hold, score, scoreColor, priority, why, poQty };
    });

    const critical = analysed.filter(r => r.hold <= 7);
    const urgent   = analysed.filter(r => r.hold > 7 && r.hold <= 15);

    // -------- DELTA ANALYSIS --------
    let deltaText = "First analysis run";
    if (LAST_AI_STATE) {
      deltaText = `Œî Critical: ${critical.length - LAST_AI_STATE.critical}, Œî Urgent: ${urgent.length - LAST_AI_STATE.urgent}`;
    }
    LAST_AI_STATE = { critical: critical.length, urgent: urgent.length };

    // -------- SUMMARY --------
    const summary = `
Pearl AI Summary ‚Äì ${document.getElementById('displayDate').innerText}

Critical Items: ${critical.length}
Urgent Items: ${urgent.length}
${deltaText}
`;

    // -------- ACTIONS --------
    const actions = analysed
      .filter(r => r.hold <= 15)
      .map(r => `
        <div class="rounded-xl border border-gray-200 p-4 bg-white shadow-sm">
          <div class="flex justify-between items-center mb-1">
            <span class="text-xs font-bold">${r.priority}</span>
            <span class="relative group text-xs font-bold ${r.scoreColor} cursor-help">
  Score ${r.score} / 100

  <!-- Tooltip -->
  <span class="absolute left-1/2 -translate-x-1/2 bottom-full mb-2
               hidden group-hover:block
               w-56 p-2 text-[10px] text-white bg-gray-900
               rounded-lg shadow-lg z-50">
    Score is calculated based on:
    <br>‚Ä¢ Remaining stock days
    <br>‚Ä¢ Daily sales velocity
    <br>‚Ä¢ Reorder threshold (15 days)
  </span>
</span>
          </div>
          <div class="text-sm font-bold">${r.name}</div>
          <div class="text-xs text-gray-500 mt-1">${r.why}</div>
          <div class="mt-2 text-xs font-bold text-red-600">
            Suggested PO: ${r.poQty} units
          </div>
        </div>
      `);

    // -------- RENDER --------
    document.getElementById('aiResponse').classList.remove('hidden');
    document.getElementById('aiSummary').innerText = summary;
    document.getElementById('aiActions').innerHTML = actions.join('');
    document.getElementById('aiExportBtn').classList.remove('hidden');

    btn.disabled = false;
    btn.innerHTML = `<i data-lucide="zap" class="w-4 h-4"></i> RUN ANALYSIS`;
    lucide.createIcons();

  }, 900);
}


    function build() {
      const selectedDate = document.getElementById('dateFilter').value;
      const search = document.getElementById('searchInput').value.toLowerCase();
      const map = {};

      Object.values(REQ).forEach(item => {
          map[item["Item Code"]] = { 
            name: item["Item Name"], 
            code: item["Item Code"],
            stock: 0, 
            depotStock: { "Kerala": 0, "Palepu": 0, "Coimbatore": 0, "Bangalore": 0 },
            mfg: item["Manufacturer"] || "General", 
            prog: +item["Program Req"] || 0,
            osh: +item["OSH Req"] || 0,
            lt: +item["Lead Time"] || 0,
            ss: +item["Safety Stock"] || 0,
            prevH2: +item["Prev H2 Sales"] || 0
          };
      });

      STOCK.forEach(r => {
        if (new Date(r.Date || r.date).toISOString().split('T')[0] === selectedDate) {
            const code = r["Item Code"] || r["item code"];
            if (map[code]) {
                const k = +(r["Kerala"] || 0), p = +(r["Palepu"] || 0), c = +(r["Coimbatore"] || 0), b = +(r["Bangalore"] || 0);
                map[code].depotStock["Kerala"] += k;
                map[code].depotStock["Palepu"] += p;
                map[code].depotStock["Coimbatore"] += c;
                map[code].depotStock["Bangalore"] += b;
                map[code].stock += (k + p + c + b);
            }
        }
      });

      FINAL = Object.values(map).filter(r => r.name.toLowerCase().includes(search));
      
      FINAL.forEach(r => {
          const daily = (r.prevH2 || 0) / 180;
          r.dailySales = daily;
          r.holdDays = daily > 0 ? (r.stock / daily) : 0;
          r.reqDays = r.lt + r.ss;
      });

      const sorted = [...FINAL].sort((a,b) => b.dailySales - a.dailySales);
      sorted.forEach((item, i) => {
          if (i < sorted.length * 0.2) item.abc = 'A';
          else if (i < sorted.length * 0.5) item.abc = 'B';
          else item.abc = 'C';
      });

      renderReq();
      renderPlan();
      renderAlerts();
      renderInsights();
      renderMfg();
      lucide.createIcons();

document.getElementById('aiResponse').classList.add('hidden');
document.getElementById('aiExportBtn').classList.add('hidden');

    }

    function renderReq() {
      document.getElementById('reqBody').innerHTML = FINAL.map(r => `
          <tr class="hover:bg-gray-50/50">
            <td class="px-6 py-4 font-semibold text-gray-800 text-[10px]">${r.name}</td>
            <td class="px-6 py-4 text-indigo-600 font-bold">${Math.round(r.stock)}</td>
            <td class="px-6 py-4 text-gray-400">${Math.round(r.prog)}</td>
            <td class="px-6 py-4 text-gray-400">${Math.round(r.osh)}</td>
            <td class="px-6 py-4 font-bold ${r.stock < r.prog ? 'text-red-500' : 'text-emerald-500'}">${r.prog > 0 ? (r.stock/r.prog*100).toFixed(0) : 0}%</td>
            <td class="px-6 py-4 font-bold ${r.stock < r.osh ? 'text-red-500' : 'text-emerald-500'}">${r.osh > 0 ? (r.stock/r.osh*100).toFixed(0) : 0}%</td>
            <td class="px-6 py-4 font-black ${r.stock < r.prog ? 'text-red-500' : 'text-emerald-500'}">${Math.round(r.stock - r.prog)}</td>
            <td class="px-6 py-4 font-black ${r.stock < r.osh ? 'text-red-500' : 'text-emerald-500'}">${Math.round(r.stock - r.osh)}</td>
          </tr>`).join('');
    }

    function renderPlan() {
        document.getElementById('planBody').innerHTML = FINAL.map(r => `
            <tr>
                <td class="px-6 py-4 text-[10px] font-bold">${r.name}</td>
                <td class="px-6 py-4 font-bold">${Math.round(r.stock)}</td>
                <td class="px-6 py-4 text-gray-400">${r.reqDays}d</td>
                <td class="px-6 py-4 font-bold ${r.holdDays < r.reqDays ? 'text-red-500' : 'text-emerald-500'}">${r.holdDays.toFixed(1)}d</td>
                <td class="px-6 py-4"><span class="px-2 py-0.5 rounded-full text-[9px] font-bold ${r.holdDays < r.reqDays ? 'bg-red-50 text-red-600' : 'bg-emerald-50 text-emerald-600'}">${r.holdDays < r.reqDays ? 'At Risk' : 'Healthy'}</span></td>
                <td class="px-6 py-4 font-black text-indigo-600">${Math.round(Math.max(0, (r.reqDays - r.holdDays) * r.dailySales))}</td>
            </tr>`).join('');
    }

    function renderMfg() {
        const list = document.getElementById('mfgList');
        const mfgs = [...new Set(FINAL.map(r => r.mfg))].sort();
        list.innerHTML = mfgs.map(name => `
            <div class="mfg-item flex items-center justify-between p-3 rounded-xl border border-gray-100 bg-white cursor-pointer" onclick="selectMfg('${name}', this)">
                <span class="text-[10px] font-bold text-gray-700 uppercase tracking-tighter">${name}</span>
                <span class="bg-gray-100 text-[9px] px-2 py-0.5 rounded-full">${FINAL.filter(r => r.mfg === name).length}</span>
            </div>`).join('');
    }

    function selectMfg(name, el) {
        document.querySelectorAll('.mfg-item').forEach(i => i.classList.remove('active-mfg', 'ring-1', 'ring-indigo-500'));
        el.classList.add('active-mfg', 'ring-1', 'ring-indigo-500');
        document.getElementById('selectedMfgName').innerText = name;
        document.getElementById('mfgProductList').innerHTML = FINAL.filter(r => r.mfg === name).map(r => `
            <tr>
                <td class="px-6 py-4 text-[10px] font-medium">${r.name}</td>
                <td class="px-6 py-4 font-bold text-indigo-600">${Math.round(r.stock)}</td>
                <td class="px-6 py-4 text-gray-400">${r.holdDays.toFixed(1)} Days</td>
            </tr>`).join('');
    }

    function getReportData(type) {
        if(type === 'status') return { title: "Stock Status", headers: ["Code", "Item", "Total Stock", "Prog %", "OSH %", "Bal Prog", "Bal OSH", "Class"], rows: FINAL.map(r => [r.code, r.name, Math.round(r.stock), (r.prog > 0 ? (r.stock/r.prog*100).toFixed(0) : 0) + "%", (r.osh > 0 ? (r.stock/r.osh*100).toFixed(0) : 0) + "%", Math.round(r.stock - r.prog), Math.round(r.stock - r.osh), r.abc]) };
        if(type === 'depot') return { title: "Depot Wise Report", headers: ["Item", "Kerala", "Palepu", "Coimbatore", "Bangalore", "Total"], rows: FINAL.map(r => [r.name, Math.round(r.depotStock.Kerala), Math.round(r.depotStock.Palepu), Math.round(r.depotStock.Coimbatore), Math.round(r.depotStock.Bangalore), Math.round(r.stock)]) };
        if(type === 'shortage') return { title: "Shortages", headers: ["Item", "Stock", "Days Left", "Gap"], rows: FINAL.filter(r => r.holdDays < r.reqDays).map(r => [r.name, Math.round(r.stock), r.holdDays.toFixed(1), (r.reqDays - r.holdDays).toFixed(1)]) };
        
        if(type === 'trend') {
            const h7 = FINAL.filter(r => r.holdDays < 7).length;
            const h15 = FINAL.filter(r => r.holdDays >= 7 && r.holdDays < 15).length;
            const h30 = FINAL.filter(r => r.holdDays >= 15 && r.holdDays < 30).length;
            return {
                title: "Stock Out Trend",
                headers: ["Severity", "Item Count", "Description"],
                rows: [
                    ["Critical (<7d)", h7, "Immediate stock-out risk"],
                    ["Urgent (7-15d)", h15, "Order must be processed now"],
                    ["Caution (15-30d)", h30, "Monitor closely"]
                ]
            };
        }

        if(type === 'mfg_summary') {
            const groups = {};
            FINAL.forEach(r => {
                if(!groups[r.mfg]) groups[r.mfg] = { count: 0, totalStock: 0 };
                groups[r.mfg].count++;
                groups[r.mfg].totalStock += r.stock;
            });
            return {
                title: "Manufacturer Summary",
                headers: ["Manufacturer", "Total SKUs", "Aggregate Stock"],
                rows: Object.entries(groups).map(([m, data]) => [m, data.count, Math.round(data.totalStock)])
            };
        }

        return { title: "Report", headers: [], rows: [] };
    }

    function previewReport(t) {
        const d = getReportData(t);
        document.getElementById('modalTitle').innerText = d.title;
        document.getElementById('modalHead').innerHTML = `<tr>${d.headers.map(h => `<th class="px-4 py-3 border-b text-left">${h}</th>`).join('')}</tr>`;
        document.getElementById('modalBody').innerHTML = d.rows.map(row => `<tr>${row.map(c => `<td class="px-4 py-3">${c}</td>`).join('')}</tr>`).join('');
        document.getElementById('modalDownloadBtn').onclick = () => downloadReportXlsx(t);
        document.getElementById('reportModal').classList.remove('hidden');
        lucide.createIcons();
    }

    function closeModal() { document.getElementById('reportModal').classList.add('hidden'); }

    function downloadReportXlsx(type) {
        const data = getReportData(type);
        const wb = XLSX.utils.book_new();
        
        const wsSummary = XLSX.utils.aoa_to_sheet([data.headers, ...data.rows]);
        XLSX.utils.book_append_sheet(wb, wsSummary, "Summary");

        const rawHeaders = ["Item Code", "Item Name", "Manufacturer", "Stock", "Daily Sales", "Days Remaining", "Class"];
        const rawRows = FINAL.map(r => [r.code, r.name, r.mfg, r.stock, r.dailySales.toFixed(2), r.holdDays.toFixed(1), r.abc]);
        const wsRaw = XLSX.utils.aoa_to_sheet([rawHeaders, ...rawRows]);
        XLSX.utils.book_append_sheet(wb, wsRaw, "Raw Data");

        XLSX.writeFile(wb, `${data.title}_${document.getElementById('dateFilter').value}.xlsx`);
    }

    function renderAlerts() {
        document.getElementById('alertGrid').innerHTML = FINAL.filter(r => r.holdDays <= r.reqDays).map(r => `
            <div class="bg-white border-l-4 border-red-500 p-4 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                <div class="flex justify-between items-start mb-2">
                    <span class="text-[8px] font-black bg-red-100 text-red-600 px-2 py-0.5 rounded">LEVEL: CRITICAL</span>
                    <i data-lucide="alert-triangle" class="w-3 h-3 text-red-400"></i>
                </div>
                <p class="font-bold text-gray-800 text-[10px] leading-tight mb-3">${r.name}</p>
                <div class="flex items-center justify-between text-[10px]">
                    <span class="text-gray-400">Coverage:</span>
                    <span class="font-bold text-red-600">${r.holdDays.toFixed(1)} Days</span>
                </div>
                <div class="mt-2 pt-2 border-t border-gray-50 flex items-center justify-between text-[9px]">
                    <span class="text-gray-400">Order Target:</span>
                    <span class="font-bold text-indigo-600">${Math.round(Math.max(0, (r.reqDays - r.holdDays) * r.dailySales))} units</span>
                </div>
            </div>`).join('');
    }

    function renderInsights() {
        document.getElementById('insight-a-count').innerText = FINAL.filter(r => r.abc === 'A').length;
        document.getElementById('insight-b-count').innerText = FINAL.filter(r => r.abc === 'B').length;
        document.getElementById('insight-c-count').innerText = FINAL.filter(r => r.abc === 'C').length;
    }

    function selectAbcClass(abc) {
        document.getElementById('abcItemsContainer').classList.remove('hidden');
        document.getElementById('abcSelectedTitle').innerText = `Class ${abc} Products (${abc === 'A' ? 'High' : abc === 'B' ? 'Medium' : 'Low'} Priority)`;
        
        document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected-class'));
        document.getElementById(`card-abc-${abc.toLowerCase()}`).classList.add('selected-class');

        document.getElementById('abcProductList').innerHTML = FINAL.filter(r => r.abc === abc).map(r => `
            <tr class="hover:bg-gray-50/50">
                <td class="px-6 py-3 font-semibold text-gray-800 text-[10px]">${r.name}</td>
                <td class="px-6 py-3 text-gray-500">${r.dailySales.toFixed(2)}</td>
                <td class="px-6 py-3 font-bold text-indigo-600">${Math.round(r.stock)}</td>
                <td class="px-6 py-3">
                    <div class="flex items-center gap-2">
                        <span class="font-black ${r.holdDays < 15 ? 'text-red-500' : 'text-emerald-500'}">${r.holdDays.toFixed(1)}d</span>
                        <div class="w-16 h-1 bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full ${r.holdDays < 15 ? 'bg-red-500' : 'bg-emerald-500'}" style="width: ${Math.min(100, (r.holdDays/60)*100)}%"></div>
                        </div>
                    </div>
                </td>
            </tr>`).join('');
    }
function exportAiAnalysis() {

  const rows = FINAL
    .filter(r => r.holdDays <= 15)
    .map(r => [
      r.holdDays <= 7 ? "CRITICAL" : "URGENT",
      r.code,
      r.name,
      r.mfg,
      Math.round(r.stock),
      r.dailySales.toFixed(2),
      r.holdDays.toFixed(1),
      r.reqDays,
      Math.round(Math.max(0, (r.reqDays - r.holdDays) * r.dailySales))
    ]);

  if (rows.length === 0) {
    alert("No critical or urgent items to export.");
    return;
  }

  const wb = XLSX.utils.book_new();

  // ---------- SUMMARY SHEET ----------
  const summarySheet = XLSX.utils.aoa_to_sheet([
    ["AI Inventory Analysis Report"],
    ["Date", document.getElementById('displayDate').innerText],
    [],
    ["Total Items Analysed", FINAL.length],
    ["Critical Items (‚â§7 days)", FINAL.filter(r => r.holdDays <= 7).length],
    ["Urgent Items (8‚Äì15 days)", FINAL.filter(r => r.holdDays > 7 && r.holdDays <= 15).length],
  ]);
  XLSX.utils.book_append_sheet(wb, summarySheet, "Summary");

  // ---------- DETAILS SHEET ----------
  const detailHeaders = [
    "Severity", "Item Code", "Item Name", "Manufacturer",
    "Current Stock", "Daily Sales",
    "Days Remaining", "Req Days", "Suggested PO"
  ];

  const ws = XLSX.utils.aoa_to_sheet([detailHeaders, ...rows]);
  XLSX.utils.book_append_sheet(wb, ws, "AI Analysis");

  XLSX.writeFile(
    wb,
    `AI_Analysis_Report_${document.getElementById('dateFilter').value}.xlsx`
  );
}


    function handleDateChange(v) { document.getElementById('displayDate').innerText = v; build(); }
  </script>
</body>
</html>