<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
        }
        .nav-active {
            background-color: #eff6ff;
            color: #1d4ed8;
            border-color: #bfdbfe;
        }
        .report-card {
            transition: transform 0.2s ease;
        }
        .report-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center gap-8">
                <h1 class="text-2xl font-bold text-blue-600 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                    PO Manager
                </h1>
                <nav class="hidden md:flex gap-1 bg-gray-100 p-1 rounded-lg">
                    <button id="navTracker" onclick="showView('tracker')" class="px-4 py-1.5 rounded-md text-sm font-medium border border-transparent nav-active">Live Tracker</button>
                    <button id="navReports" onclick="showView('reports')" class="px-4 py-1.5 rounded-md text-sm font-medium border border-transparent text-gray-600 hover:bg-white transition-all">Analytics Hub</button>
                </nav>
            </div>
            <div class="flex gap-3">
                <button onclick="fetchData()" class="text-gray-500 hover:text-blue-600 p-2 transition-colors" title="Refresh Data">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                </button>
                <button onclick="openForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium shadow-md transition-all flex items-center gap-2 text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                    <span>Add New PO</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- TRACKER VIEW -->
        <div id="trackerView">
            <!-- Summary Row -->
            <div class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-xs text-gray-500 mb-1 font-bold uppercase tracking-widest">Active Open POs</p>
                    <h3 id="statTotal" class="text-3xl font-black text-blue-600">0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <p class="text-xs text-gray-500 mb-1 font-bold uppercase tracking-widest">Pending Items (Sum)</p>
                    <h3 id="statPending" class="text-3xl font-black text-orange-500">0</h3>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex items-center">
                    <div class="relative w-full">
                        <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Search PO, Item, or MFR..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <span class="absolute left-3 top-2.5 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200 mb-6">
                <button id="tabOpen" onclick="switchTab('OPEN')" class="px-6 py-2 font-bold text-sm tab-active transition-all">Open Records</button>
                <button id="tabClosed" onclick="switchTab('CLOSED')" class="px-6 py-2 font-bold text-sm text-gray-500 hover:text-blue-600 transition-all">Fulfillment History</button>
            </div>

            <!-- Table Container -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse" id="poTable">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase">Date</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase">PO Number</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase">Item Details</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase text-center">Order</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase text-center">Recv</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase text-center">Pend</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase text-center">ETA</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase">Aging</th>
                                <th class="px-4 py-4 text-xs font-semibold text-gray-500 uppercase text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
                <!-- Loading State -->
                <div id="loadingOverlay" class="p-12 flex flex-col items-center justify-center bg-white">
                    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                    <p class="text-gray-500 text-sm font-medium italic">Synchronizing database...</p>
                </div>
            </div>
        </div>

        <!-- ANALYTICS HUB VIEW -->
        <div id="reportsView" class="hidden space-y-8 animate-in fade-in duration-500">
            <!-- Key Report Figures -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm text-center">
                    <p class="text-xs font-bold text-orange-500 uppercase mb-1">Open POs</p>
                    <p id="repOpenCount" class="text-2xl font-black text-gray-800">0</p>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm text-center">
                    <p class="text-xs font-bold text-green-600 uppercase mb-1">Closed POs</p>
                    <p id="repClosedCount" class="text-2xl font-black text-gray-800">0</p>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm text-center">
                    <p class="text-xs font-bold text-red-500 uppercase mb-1">Overdue (ETA Expired)</p>
                    <p id="repOverdueCount" class="text-2xl font-black text-gray-800">0</p>
                </div>
                <div class="bg-white p-5 rounded-xl border border-gray-100 shadow-sm text-center">
                    <p class="text-xs font-bold text-blue-600 uppercase mb-1">Avg Lead Time</p>
                    <p id="repAvgLead" class="text-2xl font-black text-gray-800">0d</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- 1. Fulfillment Status (Donut) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 report-card">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-black text-gray-700 uppercase tracking-tight">Order Fulfillment</h3>
                        <button onclick="exportChartData('fulfillment')" class="text-blue-500 hover:text-blue-700 text-xs font-bold underline">Export XLS</button>
                    </div>
                    <div class="h-64"><canvas id="fulfillmentChart"></canvas></div>
                </div>

                <!-- 2. Top Suppliers (Bar) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 report-card">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-black text-gray-700 uppercase tracking-tight">Top Manufacturers</h3>
                        <button onclick="exportChartData('mfr')" class="text-blue-500 hover:text-blue-700 text-xs font-bold underline">Export XLS</button>
                    </div>
                    <div class="h-64"><canvas id="mfrChart"></canvas></div>
                </div>

                <!-- 3. Aging Report (Polar) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 report-card">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-black text-gray-700 uppercase tracking-tight">Pending Aging (Days)</h3>
                        <button onclick="exportChartData('aging')" class="text-blue-500 hover:text-blue-700 text-xs font-bold underline">Export XLS</button>
                    </div>
                    <div class="h-64"><canvas id="agingChart"></canvas></div>
                </div>

                <!-- 4. Monthly Trend (Line) -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 md:col-span-2 lg:col-span-3 report-card">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-sm font-black text-gray-700 uppercase tracking-tight">Purchase Volume Trend</h3>
                        <button onclick="exportChartData('trend')" class="text-blue-500 hover:text-blue-700 text-xs font-bold underline">Export XLS</button>
                    </div>
                    <div class="h-72"><canvas id="trendChart"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Form (Hidden by default) -->
    <div id="formModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="fixed inset-0 bg-black bg-opacity-40" onclick="closeForm()"></div>
        <div class="flex items-center justify-end min-h-screen">
            <div class="relative bg-white w-full max-w-md h-screen shadow-2xl p-8 transform transition-transform duration-300">
                <div class="flex justify-between items-center mb-8">
                    <h2 id="modalTitle" class="text-2xl font-black text-gray-800">Add PO</h2>
                    <button onclick="closeForm()" class="text-gray-400 hover:text-gray-900 text-3xl">&times;</button>
                </div>
                <form id="poForm" onsubmit="handleFormSubmit(event)" class="space-y-4">
                    <input type="hidden" id="originalPoNumber">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">PO Date</label>
                            <input type="date" id="poDate" required class="w-full border border-gray-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">PO Number</label>
                            <input type="text" id="poNumber" required class="w-full border border-gray-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <label class="block text-[10px] font-black text-blue-600 uppercase mb-1 tracking-widest">Master Item Lookup</label>
                        <input list="itemList" id="itemSelector" onchange="onItemSelect()" placeholder="Type to search master list..." class="w-full border border-blue-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-400 outline-none">
                        <datalist id="itemList"></datalist>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Item Code</label>
                            <input type="text" id="itemCode" required class="w-full border border-gray-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Manufacturer</label>
                            <input type="text" id="mfr" class="w-full border border-gray-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Item Description</label>
                        <input type="text" id="itemName" required class="w-full border border-gray-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Order Qty</label>
                            <input type="number" id="orderQty" oninput="calculatePending()" required class="w-full border border-gray-200 rounded px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Received</label>
                            <input type="number" id="receivedQty" oninput="calculatePending()" required class="w-full border border-gray-200 rounded px-3 py-2 text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Pending</label>
                            <input type="number" id="pendingQty" readonly class="w-full bg-gray-50 border border-gray-200 rounded px-3 py-2 text-sm font-bold text-orange-600">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-1">Expected ETA</label>
                        <input type="date" id="eta" class="w-full border border-gray-200 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="flex items-center gap-2 pt-2">
                        <input type="checkbox" id="closed" class="w-4 h-4 text-blue-600 rounded">
                        <label for="closed" id="closedLabel" class="text-sm font-bold text-gray-700">MANUAL CLOSE RECORD</label>
                    </div>
                    <div class="pt-6">
                        <button type="submit" id="submitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg transition-all uppercase tracking-widest text-xs">
                            Sync Data to Cloud
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-5 right-5 hidden z-50">
        <div class="bg-gray-900 text-white px-8 py-4 rounded-2xl shadow-2xl flex items-center gap-3 border border-gray-700">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span id="toastMessage" class="text-sm font-bold tracking-wide">Operation Successful</span>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx3Ihabo06aL-i1xhmeA1xWiPVk2GVtFomWuOGE9M-oUs3one-G6vLNYZwu70_TNPxU/exec';
        const ITEM_MASTER_URL = 'https://script.google.com/macros/s/AKfycbwfWL5Iu25uPYWxsRA0pLNtjSzDo86K3jXhSAw_P-RrPTlK5rLPpbLnv00X7972skCj/exec';
        
        let allPoData = [];
        let currentTab = 'OPEN';
        let masterItems = [];
        let charts = {};

        async function fetchData() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const response = await fetch(SCRIPT_URL + '?action=read');
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                allPoData = data.sort((a, b) => new Date(b.poDate) - new Date(a.poDate));
                
                renderTable();
                updateStats();
                fetchMasterItems();
                if (!document.getElementById('reportsView').classList.contains('hidden')) {
                    renderAnalytics();
                }
            } catch (error) {
                console.error("Fetch error:", error);
                showToast("Error: " + error.message);
            } finally {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function showView(view) {
            const tracker = document.getElementById('trackerView');
            const reports = document.getElementById('reportsView');
            const navTracker = document.getElementById('navTracker');
            const navReports = document.getElementById('navReports');

            if (view === 'tracker') {
                tracker.classList.remove('hidden');
                reports.classList.add('hidden');
                navTracker.classList.add('nav-active');
                navReports.classList.remove('nav-active');
            } else {
                tracker.classList.add('hidden');
                reports.classList.remove('hidden');
                navReports.classList.add('nav-active');
                navTracker.classList.remove('nav-active');
                renderAnalytics();
            }
        }

        function renderAnalytics() {
            // Cleanup existing charts
            Object.values(charts).forEach(c => c.destroy());

            // --- Aggregations ---
            const openCount = allPoData.filter(p => p.status === 'OPEN').length;
            const closedCount = allPoData.filter(p => p.status === 'CLOSED').length;
            
            const now = new Date();
            const overdue = allPoData.filter(p => p.status === 'OPEN' && p.expectedDelivery && new Date(p.expectedDelivery) < now).length;

            // Stats update
            document.getElementById('repOpenCount').innerText = openCount;
            document.getElementById('repClosedCount').innerText = closedCount;
            document.getElementById('repOverdueCount').innerText = overdue;

            // 1. Fulfillment Chart
            charts.fulfillment = new Chart(document.getElementById('fulfillmentChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Received Items', 'Pending Items'],
                    datasets: [{
                        data: [
                            allPoData.reduce((a, b) => a + Number(b.receivedQty || 0), 0),
                            allPoData.reduce((a, b) => a + Number(b.pendingQty || 0), 0)
                        ],
                        backgroundColor: ['#10b981', '#f3f4f6'],
                        borderWidth: 0
                    }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            // 2. MFR Chart
            const mfrData = {};
            allPoData.forEach(p => { mfrData[p.manufacturer || 'Unknown'] = (mfrData[p.manufacturer || 'Unknown'] || 0) + 1; });
            const topMfrs = Object.entries(mfrData).sort((a,b) => b[1] - a[1]).slice(0, 5);

            charts.mfr = new Chart(document.getElementById('mfrChart'), {
                type: 'bar',
                data: {
                    labels: topMfrs.map(x => x[0]),
                    datasets: [{
                        label: 'Total POs',
                        data: topMfrs.map(x => x[1]),
                        backgroundColor: '#2563eb',
                        borderRadius: 4
                    }]
                },
                options: { maintainAspectRatio: false, indexAxis: 'y' }
            });

            // 3. Aging Chart
            const aging = { '< 15d': 0, '15-30d': 0, '30-60d': 0, '60d+': 0 };
            allPoData.filter(p => p.status === 'OPEN').forEach(p => {
                const diff = Math.floor((now - new Date(p.poDate)) / (1000 * 60 * 60 * 24));
                if (diff < 15) aging['< 15d']++;
                else if (diff < 30) aging['15-30d']++;
                else if (diff < 60) aging['30-60d']++;
                else aging['60d+']++;
            });

            charts.aging = new Chart(document.getElementById('agingChart'), {
                type: 'polarArea',
                data: {
                    labels: Object.keys(aging),
                    datasets: [{
                        data: Object.values(aging),
                        backgroundColor: ['#dbeafe', '#93c5fd', '#3b82f6', '#1d4ed8']
                    }]
                },
                options: { maintainAspectRatio: false }
            });

            // 4. Trend Chart
            const trend = {};
            allPoData.slice().reverse().forEach(p => {
                const m = new Date(p.poDate).toLocaleString('default', { month: 'short', year: '2-digit' });
                trend[m] = (trend[m] || 0) + 1;
            });

            charts.trend = new Chart(document.getElementById('trendChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(trend),
                    datasets: [{
                        label: 'Monthly PO Count',
                        data: Object.values(trend),
                        borderColor: '#2563eb',
                        backgroundColor: '#eff6ff',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function exportChartData(type) {
            let data = [];
            let fileName = `PO_${type}_Report.xlsx`;

            if (type === 'fulfillment') {
                data = allPoData.map(p => ({
                    "PO Number": p.poNumber,
                    "Item": p.itemName,
                    "Ordered": p.orderQty,
                    "Received": p.receivedQty,
                    "Status": p.status
                }));
            } else if (type === 'mfr') {
                data = allPoData.map(p => ({
                    "Manufacturer": p.manufacturer,
                    "PO Number": p.poNumber,
                    "Date": p.poDate
                }));
            } else if (type === 'aging') {
                data = allPoData.filter(p => p.status === 'OPEN').map(p => {
                    const diff = Math.floor((new Date() - new Date(p.poDate)) / (1000 * 60 * 60 * 24));
                    return { "PO Number": p.poNumber, "Age (Days)": diff, "Date": p.poDate };
                });
            } else if (type === 'trend') {
                data = allPoData.map(p => ({ "Date": p.poDate, "PO Number": p.poNumber }));
            }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, fileName);
            showToast("Report Generated");
        }

        async function fetchMasterItems() {
            try {
                const response = await fetch(ITEM_MASTER_URL);
                const data = await response.json();
                masterItems = data;
                const datalist = document.getElementById('itemList');
                datalist.innerHTML = '';
                data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.itemName || item.Name || item[1]; 
                    option.dataset.code = item.itemCode || item.Code || item[0];
                    datalist.appendChild(option);
                });
            } catch (e) { console.warn("Master item fetch failed", e); }
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabOpen').className = tab === 'OPEN' ? 'px-6 py-2 font-bold text-sm tab-active transition-all' : 'px-6 py-2 font-bold text-sm text-gray-500 hover:text-blue-600 transition-all';
            document.getElementById('tabClosed').className = tab === 'CLOSED' ? 'px-6 py-2 font-bold text-sm tab-active transition-all' : 'px-6 py-2 font-bold text-sm text-gray-500 hover:text-blue-600 transition-all';
            renderTable();
        }

        function calculateDiff(dateStr) {
            if (!dateStr || dateStr === "-" || dateStr === "") return "-";
            const start = new Date(dateStr);
            const end = new Date();
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 365 ? `${(diffDays/365).toFixed(1)}y` : `${diffDays}d`;
        }

        function formatDisplayDate(dateStr) {
            if (!dateStr || dateStr === "-" || dateStr === "") return "-";
            const parts = dateStr.split('-');
            if (parts.length !== 3) return dateStr;
            const [y, m, d] = parts;
            return `${d}-${m}-${y}`;
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            const filteredData = allPoData.filter(row => row.status === currentTab);
            if (filteredData.length === 0) {
                tbody.innerHTML = `<tr><td colspan="9" class="px-4 py-12 text-center text-gray-400 italic font-medium">No results found in ${currentTab.toLowerCase()} list.</td></tr>`;
                return;
            }
            filteredData.forEach((row) => {
                const aging = calculateDiff(row.poDate);
                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50 transition-colors group">
                        <td class="px-4 py-4 text-xs font-semibold text-gray-500">${formatDisplayDate(row.poDate)}</td>
                        <td class="px-4 py-4 text-sm font-black text-gray-800">${row.poNumber}</td>
                        <td class="px-4 py-4">
                            <div class="text-xs font-bold text-gray-900">${row.itemName}</div>
                            <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">${row.itemCode} â€¢ ${row.manufacturer || 'General'}</div>
                        </td>
                        <td class="px-4 py-4 text-center text-sm font-bold text-blue-600">${row.orderQty}</td>
                        <td class="px-4 py-4 text-center text-sm font-bold text-green-600">${row.receivedQty}</td>
                        <td class="px-4 py-4 text-center text-sm font-black text-orange-600">${row.pendingQty}</td>
                        <td class="px-4 py-4 text-center text-xs font-bold text-gray-700">${formatDisplayDate(row.expectedDelivery) || '-'}</td>
                        <td class="px-4 py-4 text-[10px] font-black text-gray-500 uppercase tracking-widest">${aging}</td>
                        <td class="px-4 py-4 text-right">
                            <button onclick="editRowByPo('${row.poNumber}')" class="bg-gray-100 group-hover:bg-blue-600 group-hover:text-white px-3 py-1 rounded text-blue-600 font-black text-[9px] uppercase transition-all">Edit</button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateStats() {
            const openOrders = allPoData.filter(r => r.status === 'OPEN');
            document.getElementById('statTotal').innerText = openOrders.length;
            const pending = openOrders.reduce((acc, curr) => acc + (Number(curr.pendingQty) || 0), 0);
            document.getElementById('statPending').innerText = pending.toLocaleString();
        }

        function calculatePending() {
            const order = Number(document.getElementById('orderQty').value) || 0;
            const received = Number(document.getElementById('receivedQty').value) || 0;
            const pending = order - received;
            document.getElementById('pendingQty').value = pending;
            const closedCheck = document.getElementById('closed');
            if (pending <= 0 && order > 0) {
                closedCheck.checked = true;
                document.getElementById('closedLabel').innerText = "AUTO-FULFILLED (CLOSED)";
                document.getElementById('closedLabel').classList.add('text-green-600');
            } else {
                document.getElementById('closedLabel').innerText = "MANUAL CLOSE RECORD";
                document.getElementById('closedLabel').classList.remove('text-green-600');
            }
        }

        function onItemSelect() {
            const inputVal = document.getElementById('itemSelector').value;
            const options = document.getElementById('itemList').childNodes;
            for(let opt of options) {
                if(opt.value === inputVal) {
                    document.getElementById('itemName').value = opt.value;
                    document.getElementById('itemCode').value = opt.dataset.code || '';
                    break;
                }
            }
        }

        function openForm() {
            document.getElementById('poForm').reset();
            document.getElementById('originalPoNumber').value = '';
            document.getElementById('modalTitle').innerText = 'Add PO Record';
            document.getElementById('formModal').classList.remove('hidden');
        }

        function closeForm() {
            document.getElementById('formModal').classList.add('hidden');
        }

        function editRowByPo(poNumber) {
            const row = allPoData.find(r => r.poNumber == poNumber);
            if (!row) return;
            document.getElementById('originalPoNumber').value = row.poNumber;
            document.getElementById('modalTitle').innerText = `Update PO ${row.poNumber}`;
            document.getElementById('poDate').value = row.poDate;
            document.getElementById('poNumber').value = row.poNumber;
            document.getElementById('itemCode').value = row.itemCode;
            document.getElementById('itemName').value = row.itemName;
            document.getElementById('orderQty').value = row.orderQty;
            document.getElementById('receivedQty').value = row.receivedQty;
            document.getElementById('pendingQty').value = row.pendingQty;
            document.getElementById('mfr').value = row.manufacturer;
            document.getElementById('eta').value = row.expectedDelivery;
            document.getElementById('closed').checked = row.status === 'CLOSED';
            document.getElementById('formModal').classList.remove('hidden');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerText = 'Transmitting...';
            const originalPo = document.getElementById('originalPoNumber').value;
            const order = Number(document.getElementById('orderQty').value) || 0;
            const received = Number(document.getElementById('receivedQty').value) || 0;
            const isClosed = document.getElementById('closed').checked || (order <= received && order > 0);
            const payload = {
                action: originalPo === '' ? 'create' : 'update',
                originalPo: originalPo,
                data: {
                    "PO Date": document.getElementById('poDate').value,
                    "PO Number": document.getElementById('poNumber').value,
                    "Item Code": document.getElementById('itemCode').value,
                    "Item Name": document.getElementById('itemName').value,
                    "Order Qty": order,
                    "Received Qty": received,
                    "Pending Qty": order - received,
                    "MFR": document.getElementById('mfr').value,
                    "ETA": document.getElementById('eta').value,
                    "Closed": isClosed ? "Yes" : "No"
                }
            };
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                showToast("Data Sync Successful");
                closeForm();
                setTimeout(fetchData, 2000); 
            } catch (err) { showToast("Error: " + err.message); }
            finally { btn.disabled = false; btn.innerText = 'Sync Data to Cloud'; }
        }

        function filterTable() {
            const input = document.getElementById('searchInput').value.toUpperCase();
            const rows = document.getElementById('tableBody').getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                rows[i].style.display = rows[i].textContent.toUpperCase().includes(input) ? "" : "none";
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').innerText = msg;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3500);
        }

        window.onload = fetchData;
    </script>
</body>
</html>