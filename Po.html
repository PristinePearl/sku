<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .loader {
            border-top-color: #3498db;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .nav-active {
            background-color: #eff6ff;
            color: #1d4ed8;
            border-color: #bfdbfe;
        }
        [v-cloak] { display: none; }
        .po-row:hover { cursor: pointer; }
        
        /* Fixed Blurry Rendering on Modals */
        .modal-container {
            transform: translateZ(0);
            backface-visibility: hidden;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900 overflow-x-hidden">

    <!-- AUTH MODAL (Triggered on Edit/New) -->
    <div id="authGate" class="fixed inset-0 z-[100] hidden bg-slate-900 bg-opacity-80 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center border-t-4 border-blue-600">
            <div class="mb-6 inline-flex p-4 bg-blue-50 rounded-full text-blue-600">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            </div>
            <h2 class="text-2xl font-black text-gray-800 mb-2">Management Access</h2>
            <p class="text-gray-500 text-sm mb-8">Verification required to modify records.</p>
            <form onsubmit="verifyAccess(event)" class="space-y-4">
                <input type="password" id="gatePassword" placeholder="••••••••" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold tracking-widest" autofocus>
                <div class="flex gap-2">
                    <button type="button" onclick="closeAuthGate()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold py-3 rounded-xl transition-all">Cancel</button>
                    <button type="submit" class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg uppercase tracking-wider">Verify</button>
                </div>
            </form>
            <p id="gateError" class="text-red-500 text-xs mt-4 font-bold hidden">Invalid Password.</p>
        </div>
    </div>

    <!-- MAIN APP CONTENT -->
    <div id="appContainer">
        <header class="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center gap-8">
                    <h1 class="text-2xl font-black text-blue-600 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                        PO TRACKER
                    </h1>
                    <nav class="hidden md:flex gap-1 bg-gray-100 p-1 rounded-lg">
                        <button id="navTracker" onclick="showView('tracker')" class="px-6 py-2 rounded-md text-sm font-bold border border-transparent nav-active transition-all">Live Tracker</button>
                        <button id="navReports" onclick="showView('reports')" class="px-6 py-2 rounded-md text-sm font-bold border border-transparent text-gray-500 hover:bg-white transition-all">Reporting Hub</button>
                    </nav>
                </div>
                <div class="flex gap-4">
                    <button onclick="fetchData()" class="bg-gray-100 hover:bg-gray-200 text-gray-600 p-2 rounded-lg transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>
                    </button>
                    <button onclick="triggerNewEntry()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold shadow-md transition-all flex items-center gap-2 text-sm uppercase tracking-wide">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                        <span>New Entry</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- VIEW: TRACKER -->
            <div id="trackerView">
                <div class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-1">Total Open POs</p>
                        <h3 id="statTotal" class="text-3xl font-black text-blue-600">0</h3>
                    </div>
                    <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                        <p class="text-[10px] text-gray-400 font-black uppercase tracking-widest mb-1">Total Pending Qty</p>
                        <h3 id="statPending" class="text-3xl font-black text-orange-500">0</h3>
                    </div>
                    <div class="md:col-span-2 bg-white p-2 rounded-xl border border-gray-200 shadow-sm flex items-center">
                        <div class="relative w-full">
                            <input type="text" id="searchInput" onkeyup="filterTable()" placeholder="Quick search PO # or Manufacturer..." class="w-full pl-10 pr-4 py-3 bg-gray-50 rounded-lg outline-none text-sm font-medium">
                            <span class="absolute left-3 top-3.5 text-gray-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="flex border-b border-gray-200 mb-6 gap-8">
                    <button id="tabOpen" onclick="switchTab('OPEN')" class="pb-3 text-sm font-black uppercase tracking-wider text-blue-600 border-b-2 border-blue-600">Open Orders</button>
                    <button id="tabClosed" onclick="switchTab('CLOSED')" class="pb-3 text-sm font-black uppercase tracking-wider text-gray-400 hover:text-blue-600 border-b-2 border-transparent transition-all">Fulfilled History</button>
                </div>

                <div class="bg-white rounded-xl shadow-xl overflow-hidden border border-gray-200">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase">Date</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase">PO #</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase">Manufacturer</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase">Line Items</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase text-center">Aging</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase">Next ETA</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase text-center">Pend Qty</th>
                                    <th class="px-6 py-4 text-[10px] font-black text-gray-400 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-gray-100"></tbody>
                        </table>
                    </div>
                    <div id="loadingOverlay" class="p-12 flex flex-col items-center justify-center bg-white">
                        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                        <p class="text-gray-500 text-sm font-bold animate-pulse italic">Connecting to database...</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: REPORTING HUB -->
            <div id="reportsView" class="hidden animate-in fade-in duration-300">
                <div class="bg-white p-6 rounded-2xl border border-gray-200 shadow-lg mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-6 items-end">
                        <div class="col-span-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Start Date</label>
                            <input type="date" id="repStart" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">End Date</label>
                            <input type="date" id="repEnd" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Report Type</label>
                            <select id="repType" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold bg-white">
                                <option value="DETAIL">Detailed Ledger</option>
                                <option value="AGING">Aging Analysis</option>
                                <option value="MFR">Manufacturer Summary</option>
                                <option value="PENDING">Pending Only</option>
                            </select>
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Status</label>
                            <select id="repStatus" class="w-full px-4 py-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500 font-bold bg-white">
                                <option value="ALL">All Records</option>
                                <option value="OPEN">Open Only</option>
                                <option value="CLOSED">Closed Only</option>
                            </select>
                        </div>
                        <div class="flex gap-2 lg:col-span-1">
                            <button onclick="generateReport()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg transition-all">Generate</button>
                            <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-xl shadow-lg transition-all flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="reportPreviewContainer" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="reportTitle" class="text-xl font-black text-gray-800 uppercase tracking-tight">Report Preview</h2>
                        <span id="reportCount" class="text-sm font-medium text-gray-400"></span>
                    </div>
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-200">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse" id="excelData">
                                <thead id="reportTableHeader" class="bg-slate-900 border-b border-gray-200"></thead>
                                <tbody id="reportTableBody" class="divide-y divide-gray-100 text-sm"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ENTRY FORM MODAL -->
    <div id="formModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="fixed inset-0 bg-slate-900 bg-opacity-70" onclick="closeForm()"></div>
        <div class="flex items-center justify-end min-h-screen">
            <div class="relative bg-white w-full max-w-2xl h-screen shadow-2xl p-10 transform transition-transform duration-300 border-l-8 border-blue-600 overflow-y-auto modal-container">
                <div class="flex justify-between items-center mb-8">
                    <h2 id="modalTitle" class="text-2xl font-black text-slate-900 uppercase">PO Entry</h2>
                    <button onclick="closeForm()" class="text-slate-400 hover:text-red-500 transition-all">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                
                <form id="poForm" onsubmit="handleFormSubmit(event)" class="space-y-8">
                    <input type="hidden" id="originalPoNumber">
                    
                    <!-- Header Info -->
                    <div class="grid grid-cols-2 gap-6 bg-gray-50 p-6 rounded-2xl border border-gray-200">
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">PO Reference #</label>
                            <input type="text" id="poNumber" required class="w-full border-2 border-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none font-black text-lg shadow-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">PO Date</label>
                            <input type="date" id="poDate" required class="w-full border-2 border-white rounded-xl px-4 py-3 focus:border-blue-500 outline-none font-bold shadow-sm">
                        </div>
                    </div>

                    <!-- Products List -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest">Products / Items</h3>
                            <button type="button" onclick="addProductRow()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-black flex items-center gap-2 transition-all shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
                                ADD ITEM
                            </button>
                        </div>
                        
                        <div id="productRowsContainer" class="space-y-4">
                            <!-- Dynamic Rows Here -->
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-slate-900 hover:bg-black text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase tracking-[0.2em] text-sm mt-8">Sync PO to Database</button>
                </form>
            </div>
        </div>
    </div>

    <!-- PO DETAILS PANEL (Read-only / Mini View) -->
    <div id="detailsModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="fixed inset-0 bg-slate-900 bg-opacity-70" onclick="toggleDetails()"></div>
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white w-full max-w-4xl rounded-3xl shadow-2xl overflow-hidden modal-container">
                <div id="detailsContent"></div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 hidden z-[200]">
        <div class="bg-slate-900 text-white px-10 py-4 rounded-full shadow-2xl border-t-2 border-blue-500 font-bold text-sm tracking-widest uppercase">
            Action Recorded
        </div>
    </div>

    <datalist id="itemList"></datalist>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby_lJguRPf_BLXiwdaPGxMk6w7krVY6p4wfXCZjATV7wKSEMXrqkoUke9oYHCIpcsUy/exec';
        const ITEM_MASTER_URL = 'https://script.google.com/macros/s/AKfycbwfWL5Iu25uPYWxsRA0pLNtjSzDo86K3jXhSAw_P-RrPTlK5rLPpbLnv00X7972skCj/exec';
        const APP_PASSWORD = "po123";

        let allPoData = [];
        let groupedData = {};
        let currentTab = 'OPEN';
        let pendingAction = null; 
        let isAuthenticated = false;

        window.onload = fetchData;

        function triggerNewEntry() {
            if (isAuthenticated) {
                openForm();
            } else {
                pendingAction = 'NEW';
                document.getElementById('authGate').classList.remove('hidden');
                document.getElementById('gatePassword').focus();
            }
        }

        function triggerEdit(poNum) {
            if (isAuthenticated) {
                editPo(poNum);
            } else {
                pendingAction = { type: 'EDIT', poNum: poNum };
                document.getElementById('authGate').classList.remove('hidden');
                document.getElementById('gatePassword').focus();
            }
        }

        function verifyAccess(e) {
            e.preventDefault();
            const pass = document.getElementById('gatePassword').value;
            if (pass === APP_PASSWORD) {
                isAuthenticated = true;
                document.getElementById('authGate').classList.add('hidden');
                document.getElementById('gatePassword').value = '';
                document.getElementById('gateError').classList.add('hidden');
                
                if (pendingAction === 'NEW') {
                    openForm();
                } else if (pendingAction && pendingAction.type === 'EDIT') {
                    editPo(pendingAction.poNum);
                }
                pendingAction = null;
            } else {
                document.getElementById('gateError').classList.remove('hidden');
                document.getElementById('gatePassword').value = '';
            }
        }

        function closeAuthGate() {
            document.getElementById('authGate').classList.add('hidden');
            document.getElementById('gatePassword').value = '';
            document.getElementById('gateError').classList.add('hidden');
            pendingAction = null;
        }

        async function fetchData() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            try {
                const response = await fetch(SCRIPT_URL + '?action=read');
                const data = await response.json();
                allPoData = data;
                processData();
                renderTable();
                updateStats();
                fetchMasterItems();
            } catch (err) { console.error(err); }
            finally { document.getElementById('loadingOverlay').classList.add('hidden'); }
        }

        function processData() {
            groupedData = {};
            allPoData.forEach(row => {
                const po = row.poNumber;
                if (!groupedData[po]) {
                    groupedData[po] = {
                        poNumber: po,
                        poDate: row.poDate,
                        manufacturer: row.manufacturer || 'General',
                        status: 'CLOSED',
                        items: [],
                        totalOrdered: 0,
                        totalPending: 0,
                        nextEta: null,
                        agingDays: 0
                    };
                }
                groupedData[po].items.push(row);
                groupedData[po].totalOrdered += Number(row.orderQty);
                groupedData[po].totalPending += Number(row.pendingQty);
                
                if (row.expectedDelivery) {
                    const rowDate = new Date(row.expectedDelivery);
                    if (!groupedData[po].nextEta || rowDate < new Date(groupedData[po].nextEta)) {
                        groupedData[po].nextEta = row.expectedDelivery;
                    }
                }

                if (row.status === 'OPEN') groupedData[po].status = 'OPEN';
            });

            const today = new Date();
            Object.values(groupedData).forEach(po => {
                const createDate = new Date(po.poDate);
                const diffTime = Math.abs(today - createDate);
                po.agingDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            });
        }

        async function fetchMasterItems() {
            try {
                const response = await fetch(ITEM_MASTER_URL);
                const data = await response.json();
                const datalist = document.getElementById('itemList');
                datalist.innerHTML = '';
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.itemName || item.Name || item[1];
                    opt.dataset.code = item.itemCode || item.Code || item[0];
                    datalist.appendChild(opt);
                });
            } catch (e) { console.warn("Master Item Load Error"); }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            
            const sortedKeys = Object.keys(groupedData).sort((a, b) => new Date(groupedData[b].poDate) - new Date(groupedData[a].poDate));
            const filtered = sortedKeys.filter(key => groupedData[key].status === currentTab);
            
            if (filtered.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" class="px-6 py-20 text-center text-gray-400 font-bold italic tracking-wide">No POs found in ${currentTab}</td></tr>`;
                return;
            }

            filtered.forEach(key => {
                const po = groupedData[key];
                const agingClass = po.agingDays > 30 ? 'text-red-600' : (po.agingDays > 15 ? 'text-orange-500' : 'text-slate-800');
                
                tbody.innerHTML += `
                    <tr onclick="viewPoDetails('${po.poNumber}')" class="po-row hover:bg-blue-50/50 transition-colors group border-b border-gray-50 last:border-0">
                        <td class="px-6 py-5 text-xs font-bold text-gray-500 whitespace-nowrap">${formatDate(po.poDate)}</td>
                        <td class="px-6 py-5 text-sm font-black text-slate-800 whitespace-nowrap">${po.poNumber}</td>
                        <td class="px-6 py-5 text-sm font-bold text-blue-600">${po.manufacturer}</td>
                        <td class="px-6 py-5 text-xs text-gray-500 font-medium">${po.items.length} Product(s)</td>
                        <td class="px-6 py-5 text-center text-sm font-black ${agingClass}">${po.agingDays}d</td>
                        <td class="px-6 py-5 text-xs font-bold text-slate-600">${po.nextEta ? formatDate(po.nextEta) : 'N/A'}</td>
                        <td class="px-6 py-5 text-center font-black text-orange-600">${po.totalPending}</td>
                        <td class="px-6 py-5">
                            <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${po.status === 'OPEN' ? 'bg-orange-100 text-orange-600' : 'bg-green-100 text-green-600'}">
                                ${po.status}
                            </span>
                        </td>
                    </tr>
                `;
            });
        }

        function viewPoDetails(poNum) {
            const po = groupedData[poNum];
            const content = document.getElementById('detailsContent');
            
            let itemsHtml = po.items.map(item => `
                <div class="grid grid-cols-12 gap-4 py-4 border-b border-gray-100 last:border-0 items-center">
                    <div class="col-span-4">
                        <div class="text-sm font-black text-slate-900">${item.itemName}</div>
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">${item.itemCode}</div>
                    </div>
                    <div class="col-span-2 text-center text-sm font-bold text-blue-600">${item.orderQty} <span class="text-[9px] block text-gray-400 font-black uppercase">Ordered</span></div>
                    <div class="col-span-2 text-center text-sm font-bold text-green-600">${item.receivedQty} <span class="text-[9px] block text-gray-400 font-black uppercase">Recv</span></div>
                    <div class="col-span-2 text-center text-sm font-black text-orange-600">${item.pendingQty} <span class="text-[9px] block text-gray-400 font-black uppercase">Pend</span></div>
                    <div class="col-span-2 text-right text-xs font-bold text-slate-500">${item.expectedDelivery ? formatDate(item.expectedDelivery) : '-'} <span class="text-[9px] block text-gray-400 font-black uppercase">ETA</span></div>
                </div>
            `).join('');

            content.innerHTML = `
                <div class="bg-slate-900 p-8 text-white flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-black uppercase tracking-[0.3em] text-blue-400 mb-1">Purchase Order Detail</p>
                        <h2 class="text-3xl font-black">${po.poNumber}</h2>
                        <p class="text-sm font-bold text-slate-400 mt-1">${formatDate(po.poDate)} • ${po.manufacturer}</p>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="triggerEdit('${po.poNumber}')" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg transition-all">Edit Record</button>
                        <button onclick="toggleDetails()" class="bg-slate-800 text-slate-400 p-3 rounded-xl hover:text-white transition-all">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                        </button>
                    </div>
                </div>
                <div class="p-8">
                    <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100">
                        ${itemsHtml}
                    </div>
                </div>
            `;
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function toggleDetails() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        let productCount = 0;
        function addProductRow(data = null) {
            const container = document.getElementById('productRowsContainer');
            const id = ++productCount;
            const div = document.createElement('div');
            div.id = `row-${id}`;
            div.className = "bg-white p-6 rounded-2xl border-2 border-gray-100 relative product-entry-row";
            
            div.innerHTML = `
                <button type="button" onclick="removeProductRow(${id})" class="absolute -top-3 -right-3 bg-red-100 text-red-500 p-1.5 rounded-full hover:bg-red-500 hover:text-white transition-all shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
                <div class="grid grid-cols-12 gap-4">
                    <div class="col-span-8 lg:col-span-6">
                        <label class="text-[9px] font-black text-gray-400 uppercase mb-1 block">Item Lookup / Description</label>
                        <input list="itemList" class="item-name w-full border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold outline-none focus:border-blue-500" placeholder="Search item..." value="${data?.itemName || ''}">
                    </div>
                    <div class="col-span-4 lg:col-span-3">
                        <label class="text-[9px] font-black text-gray-400 uppercase mb-1 block">Item Code</label>
                        <input class="item-code w-full border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold outline-none bg-gray-50" value="${data?.itemCode || ''}">
                    </div>
                    <div class="col-span-6 lg:col-span-3">
                        <label class="text-[9px] font-black text-gray-400 uppercase mb-1 block">MFR</label>
                        <input class="item-mfr w-full border border-gray-200 rounded-lg px-3 py-2 text-sm font-bold outline-none" value="${data?.manufacturer || ''}">
                    </div>
                    <div class="col-span-6 lg:col-span-3">
                        <label class="text-[9px] font-black text-gray-400 uppercase mb-1 block">ETA</label>
                        <input type="date" class="item-eta w-full border border-gray-200 rounded-lg px-3 py-2 text-xs font-bold outline-none" value="${data?.expectedDelivery || ''}">
                    </div>
                    <div class="col-span-4 lg:col-span-3">
                        <label class="text-[9px] font-black text-gray-400 uppercase mb-1 block">Ordered</label>
                        <input type="number" oninput="calcRow(${id})" class="item-ord w-full border border-gray-200 rounded-lg px-3 py-2 text-sm font-black text-blue-600 outline-none" value="${data?.orderQty || ''}">
                    </div>
                    <div class="col-span-4 lg:col-span-3">
                        <label class="text-[9px] font-black text-gray-400 uppercase mb-1 block">Received</label>
                        <input type="number" oninput="calcRow(${id})" class="item-recv w-full border border-gray-200 rounded-lg px-3 py-2 text-sm font-black text-green-600 outline-none" value="${data?.receivedQty || 0}">
                    </div>
                    <div class="col-span-4 lg:col-span-3">
                        <label class="text-[9px] font-black text-gray-400 uppercase mb-1 block">Pending</label>
                        <input type="number" readonly class="item-pend w-full border-none bg-orange-50 rounded-lg px-3 py-2 text-sm font-black text-orange-600 outline-none" value="${data?.pendingQty || 0}">
                    </div>
                </div>
            `;
            container.appendChild(div);
            
            const nameInput = div.querySelector('.item-name');
            nameInput.addEventListener('change', (e) => {
                const opt = Array.from(document.getElementById('itemList').options).find(o => o.value === e.target.value);
                if (opt) div.querySelector('.item-code').value = opt.dataset.code;
            });
        }

        function removeProductRow(id) {
            const row = document.getElementById(`row-${id}`);
            if (row) row.remove();
        }

        function calcRow(id) {
            const row = document.getElementById(`row-${id}`);
            const ord = Number(row.querySelector('.item-ord').value) || 0;
            const recv = Number(row.querySelector('.item-recv').value) || 0;
            row.querySelector('.item-pend').value = ord - recv;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            btn.disabled = true; btn.innerText = 'SYNCING PO...';

            const poNum = document.getElementById('poNumber').value;
            const poDate = document.getElementById('poDate').value;
            const originalPo = document.getElementById('originalPoNumber').value;

            const productRows = document.querySelectorAll('.product-entry-row');
            const dataToSync = [];

            productRows.forEach(row => {
                const ord = Number(row.querySelector('.item-ord').value);
                const recv = Number(row.querySelector('.item-recv').value);
                dataToSync.push({
                    "PO Date": poDate,
                    "PO Number": poNum,
                    "Item Code": row.querySelector('.item-code').value,
                    "Item Name": row.querySelector('.item-name').value,
                    "Order Qty": ord,
                    "Received Qty": recv,
                    "Pending Qty": ord - recv,
                    "MFR": row.querySelector('.item-mfr').value,
                    "ETA": row.querySelector('.item-eta').value,
                    "Closed": (ord - recv <= 0) ? "Yes" : "No"
                });
            });

            const payload = {
                action: originalPo === '' ? 'create_batch' : 'update_batch',
                originalPo: originalPo,
                entries: dataToSync
            };

            try {
                await fetch(SCRIPT_URL, {
  method: 'POST',
  headers: {
    "Content-Type": "application/json"
  },
  body: JSON.stringify(payload)
});
                showToast();
                closeForm();
                setTimeout(fetchData, 1500);
            } catch (err) {
  console.error(err);
  alert("Sync Failed – check console");
}
            finally { btn.disabled = false; btn.innerText = 'SYNC PO TO DATABASE'; }
        }

        function editPo(poNum) {
            const po = groupedData[poNum];
            document.getElementById('detailsModal').classList.add('hidden');
            
            document.getElementById('originalPoNumber').value = po.poNumber;
            document.getElementById('poNumber').value = po.poNumber;
            document.getElementById('poDate').value = po.poDate;
            document.getElementById('modalTitle').innerText = `EDIT PO ${po.poNumber}`;
            
            document.getElementById('productRowsContainer').innerHTML = '';
            po.items.forEach(item => addProductRow(item));
            
            document.getElementById('formModal').classList.remove('hidden');
        }

        function openForm() {
            document.getElementById('poForm').reset();
            document.getElementById('originalPoNumber').value = '';
            document.getElementById('modalTitle').innerText = 'NEW PO ENTRY';
            document.getElementById('poDate').valueAsDate = new Date();
            document.getElementById('productRowsContainer').innerHTML = '';
            addProductRow();
            document.getElementById('formModal').classList.remove('hidden');
        }

        function closeForm() { document.getElementById('formModal').classList.add('hidden'); }

        function showView(v) {
            document.getElementById('trackerView').classList.toggle('hidden', v !== 'tracker');
            document.getElementById('reportsView').classList.toggle('hidden', v !== 'reports');
            document.getElementById('navTracker').classList.toggle('nav-active', v === 'tracker');
            document.getElementById('navReports').classList.toggle('nav-active', v === 'reports');
        }

        function updateStats() {
            const keys = Object.keys(groupedData);
            const openPos = keys.filter(k => groupedData[k].status === 'OPEN');
            document.getElementById('statTotal').innerText = openPos.length;
            document.getElementById('statPending').innerText = openPos.reduce((a, b) => a + groupedData[b].totalPending, 0).toLocaleString();
        }

        function filterTable() {
            const q = document.getElementById('searchInput').value.toUpperCase();
            const rows = document.getElementById('tableBody').rows;
            for (let r of rows) r.style.display = r.innerText.toUpperCase().includes(q) ? "" : "none";
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tabOpen').className = tab === 'OPEN' ? 'pb-3 text-sm font-black uppercase tracking-wider text-blue-600 border-b-2 border-blue-600' : 'pb-3 text-sm font-black uppercase tracking-wider text-gray-400 hover:text-blue-600 border-b-2 border-transparent transition-all';
            document.getElementById('tabClosed').className = tab === 'CLOSED' ? 'pb-3 text-sm font-black uppercase tracking-wider text-blue-600 border-b-2 border-blue-600' : 'pb-3 text-sm font-black uppercase tracking-wider text-gray-400 hover:text-blue-600 border-b-2 border-transparent transition-all';
            renderTable();
        }

        function formatDate(d) {
            if(!d) return "-";
            const parts = d.split('-');
            return parts.length === 3 ? `${parts[2]}/${parts[1]}/${parts[0]}` : d;
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2500);
        }

        // --- NEW: Reporting & Export Functions ---
        function generateReport() {
            const start = document.getElementById('repStart').value;
            const end = document.getElementById('repEnd').value;
            const type = document.getElementById('repType').value;
            const status = document.getElementById('repStatus').value;

            let filtered = allPoData.filter(row => {
                const poDate = row.poDate;
                const statusMatch = status === 'ALL' || row.status === status;
                const dateMatch = (!start || poDate >= start) && (!end || poDate <= end);
                return statusMatch && dateMatch;
            });

            const header = document.getElementById('reportTableHeader');
            const body = document.getElementById('reportTableBody');
            header.innerHTML = '';
            body.innerHTML = '';

            const createHeader = (cols) => {
                const tr = document.createElement('tr');
                cols.forEach(c => {
                    const th = document.createElement('th');
                    th.className = "px-4 py-3 text-[10px] font-black text-white uppercase tracking-widest";
                    th.innerText = c;
                    tr.appendChild(th);
                });
                header.appendChild(tr);
            };

            if (type === 'DETAIL') {
                createHeader(['Date', 'PO #', 'MFR', 'Item', 'Code', 'Ord', 'Recv', 'Pend', 'ETA']);
                filtered.forEach(r => {
                    body.innerHTML += `<tr>
                        <td class="px-4 py-3 font-bold">${formatDate(r.poDate)}</td>
                        <td class="px-4 py-3 font-black">${r.poNumber}</td>
                        <td class="px-4 py-3">${r.manufacturer}</td>
                        <td class="px-4 py-3 font-medium">${r.itemName}</td>
                        <td class="px-4 py-3 text-xs text-gray-400">${r.itemCode}</td>
                        <td class="px-4 py-3 text-center">${r.orderQty}</td>
                        <td class="px-4 py-3 text-center">${r.receivedQty}</td>
                        <td class="px-4 py-3 text-center font-black text-orange-600">${r.pendingQty}</td>
                        <td class="px-4 py-3">${formatDate(r.expectedDelivery)}</td>
                    </tr>`;
                });
            } else if (type === 'MFR') {
                createHeader(['Manufacturer', 'Total POs', 'Unique Items', 'Total Pending']);
                const mfrData = {};
                filtered.forEach(r => {
                    if(!mfrData[r.manufacturer]) mfrData[r.manufacturer] = { pos: new Set(), items: new Set(), pend: 0 };
                    mfrData[r.manufacturer].pos.add(r.poNumber);
                    mfrData[r.manufacturer].items.add(r.itemCode);
                    mfrData[r.manufacturer].pend += Number(r.pendingQty);
                });
                Object.entries(mfrData).forEach(([name, data]) => {
                    body.innerHTML += `<tr>
                        <td class="px-4 py-3 font-black text-blue-600">${name}</td>
                        <td class="px-4 py-3 font-bold text-center">${data.pos.size}</td>
                        <td class="px-4 py-3 font-bold text-center">${data.items.size}</td>
                        <td class="px-4 py-3 font-black text-center text-orange-600">${data.pend}</td>
                    </tr>`;
                });
            } else if (type === 'AGING') {
                createHeader(['PO #', 'Date', 'Aging (Days)', 'Manufacturer', 'Total Pending Qty']);
                const today = new Date();
                const processedPos = new Set();
                filtered.forEach(r => {
                    if (processedPos.has(r.poNumber)) return;
                    const po = groupedData[r.poNumber];
                    body.innerHTML += `<tr>
                        <td class="px-4 py-3 font-black">${po.poNumber}</td>
                        <td class="px-4 py-3">${formatDate(po.poDate)}</td>
                        <td class="px-4 py-3 font-black ${po.agingDays > 30 ? 'text-red-600' : 'text-slate-800'}">${po.agingDays}d</td>
                        <td class="px-4 py-3">${po.manufacturer}</td>
                        <td class="px-4 py-3 font-black text-orange-600">${po.totalPending}</td>
                    </tr>`;
                    processedPos.add(r.poNumber);
                });
            } else if (type === 'PENDING') {
                createHeader(['PO #', 'Item', 'Code', 'Pending Qty', 'ETA']);
                filtered.filter(r => r.pendingQty > 0).forEach(r => {
                    body.innerHTML += `<tr>
                        <td class="px-4 py-3 font-black">${r.poNumber}</td>
                        <td class="px-4 py-3 font-medium">${r.itemName}</td>
                        <td class="px-4 py-3 text-xs text-gray-400">${r.itemCode}</td>
                        <td class="px-4 py-3 font-black text-orange-600 text-center">${r.pendingQty}</td>
                        <td class="px-4 py-3">${formatDate(r.expectedDelivery)}</td>
                    </tr>`;
                });
            }

            document.getElementById('reportPreviewContainer').classList.remove('hidden');
            document.getElementById('reportCount').innerText = `${filtered.length} records matched`;
        }

        function exportToExcel() {
            const table = document.getElementById("excelData");
            const wb = XLSX.utils.table_to_book(table, { sheet: "PO Report" });
            XLSX.writeFile(wb, `PO_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
    </script>
</body>
</html>
